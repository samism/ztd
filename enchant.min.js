(function(e,t){if(typeof Object.defineProperty!=="function"){Object.defineProperty=function(e,t,n){if("value"in n){e[t]=n.value}if("get"in n){e.__defineGetter__(t,n.get)}if("set"in n){e.__defineSetter__(t,n.set)}return e}}if(typeof Object.defineProperties!=="function"){Object.defineProperties=function(e,t){for(var n in t){if(t.hasOwnProperty(n)){Object.defineProperty(e,n,t[n])}}return e}}if(typeof Object.create!=="function"){Object.create=function(e,t){function n(){}n.prototype=e;var r=new n;if(t!=null){Object.defineProperties(r,t)}return r}}if(typeof Object.getPrototypeOf!=="function"){Object.getPrototypeOf=function(e){return e.__proto__}}if(typeof Function.prototype.bind!=="function"){Function.prototype.bind=function(t){var n=this;var r=Array.prototype.slice.call(arguments,1);var i=function(){};var s=function(){var s=r.concat(Array.prototype.slice.call(arguments));return n.apply(this instanceof i?this:t||e,s)};i.prototype=n.prototype;s.prototype=new i;return s}}e.getTime=function(){var t;if(e.performance&&e.performance.now){t=Date.now();return function(){return t+e.performance.now()}}else if(e.performance&&e.performance.webkitNow){t=Date.now();return function(){return t+e.performance.webkitNow()}}else{return Date.now}}();e.requestAnimationFrame=e.requestAnimationFrame||e.mozRequestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||function(){var t=e.getTime();var n=1e3/60;return function(r){var i=setTimeout(function(){t=e.getTime();r(t)},Math.max(0,t+n-e.getTime()));return i}}();var n=function(t){if(t!=null){if(!(t instanceof Array)){t=Array.prototype.slice.call(arguments)}t=t.filter(function(e){return[e].join()})}(function r(n,i){var s=[],o,u;for(var a in n){if(n.hasOwnProperty(a)){if(typeof n[a]==="function"){e[a]=n[a]}else if(typeof n[a]==="object"&&n[a]!==null&&Object.getPrototypeOf(n[a])===Object.prototype){if(t==null){s.push(a)}else{o=t.indexOf(i+a);if(o!==-1){s.push(a);t.splice(o,1)}}}}}for(o=0,u=s.length;o<u;o++){r(n[s[o]],i+s[o]+".")}})(n,"");if(n.Class.getInheritanceTree(e.Game).length<=n.Class.getInheritanceTree(e.Core).length){e.Game=e.Core}if(t!=null&&t.length){throw new Error("Cannot load module: "+t.join(", "))}};e.enchant=n;e.addEventListener("message",function(e,t){try{var r=JSON.parse(e.data);if(r.type==="event"){n.Core.instance.dispatchEvent(new n.Event(r.value))}else if(r.type==="debug"){switch(r.value){case"start":n.Core.instance.start();break;case"pause":n.Core.instance.pause();break;case"resume":n.Core.instance.resume();break;case"tick":n.Core.instance._tick();break;default:break}}}catch(i){}},false);n.Class=function(e,t){return n.Class.create(e,t)};n.Class.create=function(e,t){if(e==null&&t){throw new Error("superclass is undefined (enchant.Class.create)")}else if(e==null){throw new Error("definition is undefined (enchant.Class.create)")}if(arguments.length===0){return n.Class.create(Object,t)}else if(arguments.length===1&&typeof arguments[0]!=="function"){return n.Class.create(Object,arguments[0])}for(var r in t){if(t.hasOwnProperty(r)){if(typeof t[r]==="object"&&t[r]!==null&&Object.getPrototypeOf(t[r])===Object.prototype){if(!("enumerable"in t[r])){t[r].enumerable=true}}else{t[r]={value:t[r],enumerable:true,writable:true}}}}var i=function(){if(this instanceof i){i.prototype.initialize.apply(this,arguments)}else{return new i}};i.prototype=Object.create(e.prototype,t);i.prototype.constructor=i;if(i.prototype.initialize==null){i.prototype.initialize=function(){e.apply(this,arguments)}}var s=this.getInheritanceTree(e);for(var o=0,u=s.length;o<u;o++){if(typeof s[o]._inherited==="function"){s[o]._inherited(i);break}}return i};n.Class.getInheritanceTree=function(e){var t=[];var n=e;var r=n.prototype;while(n!==Object){t.push(n);r=Object.getPrototypeOf(r);n=r.constructor}return t};n.ENV={VERSION:"0.8.2",BROWSER:function(e){if(/Eagle/.test(e)){return"eagle"}else if(/Opera/.test(e)){return"opera"}else if(/MSIE|Trident/.test(e)){return"ie"}else if(/Chrome/.test(e)){return"chrome"}else if(/(?:Macintosh|Windows).*AppleWebKit/.test(e)){return"safari"}else if(/(?:iPhone|iPad|iPod).*AppleWebKit/.test(e)){return"mobilesafari"}else if(/Firefox/.test(e)){return"firefox"}else if(/Android/.test(e)){return"android"}else{return""}}(navigator.userAgent),VENDOR_PREFIX:function(){var e=navigator.userAgent;if(e.indexOf("Opera")!==-1){return"O"}else if(/MSIE|Trident/.test(e)){return"ms"}else if(e.indexOf("WebKit")!==-1){return"webkit"}else if(navigator.product==="Gecko"){return"Moz"}else{return""}}(),TOUCH_ENABLED:function(){var e=document.createElement("div");e.setAttribute("ontouchstart","return");return typeof e.ontouchstart==="function"}(),RETINA_DISPLAY:function(){if(navigator.userAgent.indexOf("iPhone")!==-1&&e.devicePixelRatio===2){var t=document.querySelector('meta[name="viewport"]');if(t==null){t=document.createElement("meta");document.head.appendChild(t)}t.setAttribute("content","width=640");return true}else{return false}}(),USE_FLASH_SOUND:function(){var e=navigator.userAgent;var t=navigator.vendor||"";return location.href.indexOf("http")===0&&e.indexOf("Mobile")===-1&&t.indexOf("Apple")!==-1}(),USE_DEFAULT_EVENT_TAGS:["input","textarea","select","area"],CANVAS_DRAWING_METHODS:["putImageData","drawImage","drawFocusRing","fill","stroke","clearRect","fillRect","strokeRect","fillText","strokeText"],KEY_BIND_TABLE:{37:"left",38:"up",39:"right",40:"down"},PREVENT_DEFAULT_KEY_CODES:[37,38,39,40,32],SOUND_ENABLED_ON_MOBILE_SAFARI:true,USE_TOUCH_TO_START_SCENE:true,USE_WEBAUDIO:function(){return location.protocol!=="file:"}(),USE_ANIMATION:true};n.Event=n.Class.create({initialize:function(e){this.type=e;this.target=null;this.x=0;this.y=0;this.localX=0;this.localY=0},_initPosition:function(e,t){var r=n.Core.instance;this.x=this.localX=(e-r._pageX)/r.scale;this.y=this.localY=(t-r._pageY)/r.scale}});n.Event.LOAD="load";n.Event.ERROR="error";n.Event.CORE_RESIZE="coreresize";n.Event.PROGRESS="progress";n.Event.ENTER_FRAME="enterframe";n.Event.EXIT_FRAME="exitframe";n.Event.ENTER="enter";n.Event.EXIT="exit";n.Event.CHILD_ADDED="childadded";n.Event.ADDED="added";n.Event.ADDED_TO_SCENE="addedtoscene";n.Event.CHILD_REMOVED="childremoved";n.Event.REMOVED="removed";n.Event.REMOVED_FROM_SCENE="removedfromscene";n.Event.TOUCH_START="touchstart";n.Event.TOUCH_MOVE="touchmove";n.Event.TOUCH_END="touchend";n.Event.RENDER="render";n.Event.INPUT_START="inputstart";n.Event.INPUT_CHANGE="inputchange";n.Event.INPUT_END="inputend";n.Event.INPUT_STATE_CHANGED="inputstatechanged";n.Event.LEFT_BUTTON_DOWN="leftbuttondown";n.Event.LEFT_BUTTON_UP="leftbuttonup";n.Event.RIGHT_BUTTON_DOWN="rightbuttondown";n.Event.RIGHT_BUTTON_UP="rightbuttonup";n.Event.UP_BUTTON_DOWN="upbuttondown";n.Event.UP_BUTTON_UP="upbuttonup";n.Event.DOWN_BUTTON_DOWN="downbuttondown";n.Event.DOWN_BUTTON_UP="downbuttonup";n.Event.A_BUTTON_DOWN="abuttondown";n.Event.A_BUTTON_UP="abuttonup";n.Event.B_BUTTON_DOWN="bbuttondown";n.Event.B_BUTTON_UP="bbuttonup";n.Event.ADDED_TO_TIMELINE="addedtotimeline";n.Event.REMOVED_FROM_TIMELINE="removedfromtimeline";n.Event.ACTION_START="actionstart";n.Event.ACTION_END="actionend";n.Event.ACTION_TICK="actiontick";n.Event.ACTION_ADDED="actionadded";n.Event.ACTION_REMOVED="actionremoved";n.Event.ANIMATION_END="animationend";n.EventTarget=n.Class.create({initialize:function(){this._listeners={}},addEventListener:function(e,t){var n=this._listeners[e];if(n==null){this._listeners[e]=[t]}else if(n.indexOf(t)===-1){n.unshift(t)}},on:function(){this.addEventListener.apply(this,arguments)},removeEventListener:function(e,t){var n=this._listeners[e];if(n!=null){var r=n.indexOf(t);if(r!==-1){n.splice(r,1)}}},clearEventListener:function(e){if(e!=null){delete this._listeners[e]}else{this._listeners={}}},dispatchEvent:function(e){e.target=this;e.localX=e.x-this._offsetX;e.localY=e.y-this._offsetY;if(this["on"+e.type]!=null){this["on"+e.type](e)}var t=this._listeners[e.type];if(t!=null){t=t.slice();for(var n=0,r=t.length;n<r;n++){t[n].call(this,e)}}}});(function(){var t;n.Core=n.Class.create(n.EventTarget,{initialize:function(r,i){if(e.document.body===null){throw new Error("document.body is null. Please excute 'new Core()' in window.onload.")}n.EventTarget.call(this);var s=true;if(t){s=false;t.stop()}t=n.Core.instance=this;this._calledTime=0;this._mousedownID=0;this._surfaceID=0;this._soundID=0;this._scenes=[];r=r||320;i=i||320;var o=document.getElementById("enchant-stage");var u,a,f;if(!o){o=document.createElement("div");o.id="enchant-stage";o.style.position="absolute";if(document.body.firstChild){document.body.insertBefore(o,document.body.firstChild)}else{document.body.appendChild(o)}u=Math.min(e.innerWidth/r,e.innerHeight/i);this._pageX=o.getBoundingClientRect().left;this._pageY=o.getBoundingClientRect().top}else{var l=e.getComputedStyle(o);a=parseInt(l.width,10);f=parseInt(l.height,10);if(a&&f){u=Math.min(a/r,f/i)}else{u=1}while(o.firstChild){o.removeChild(o.firstChild)}o.style.position="relative";var c=o.getBoundingClientRect();this._pageX=Math.round(e.scrollX||e.pageXOffset+c.left);this._pageY=Math.round(e.scrollY||e.pageYOffset+c.top)}o.style.fontSize="12px";o.style.webkitTextSizeAdjust="none";o.style.webkitTapHighlightColor="rgba(0, 0, 0, 0)";this._element=o;this.addEventListener("coreresize",this._oncoreresize);this._width=r;this._height=i;this.scale=u;this.fps=30;this.frame=0;this.ready=false;this.running=false;this.assets={};var h=this._assets=[];(function v(e){if(e.assets){n.Core.instance.preload(e.assets)}for(var t in e){if(e.hasOwnProperty(t)){if(typeof e[t]==="object"&&e[t]!==null&&Object.getPrototypeOf(e[t])===Object.prototype){v(e[t])}}}})(n);this.currentScene=null;this.rootScene=new n.Scene;this.pushScene(this.rootScene);this.loadingScene=new n.LoadingScene;this._activated=false;this._offsetX=0;this._offsetY=0;this.input={};this.keyboardInputManager=new n.KeyboardInputManager(e.document,this.input);this.keyboardInputManager.addBroadcastTarget(this);this._keybind=this.keyboardInputManager._binds;if(!n.ENV.KEY_BIND_TABLE){n.ENV.KEY_BIND_TABLE={}}for(var p in n.ENV.KEY_BIND_TABLE){this.keybind(p,n.ENV.KEY_BIND_TABLE[p])}if(s){o=n.Core.instance._element;var d;document.addEventListener("keydown",function(e){t.dispatchEvent(new n.Event("keydown"));if(n.ENV.PREVENT_DEFAULT_KEY_CODES.indexOf(e.keyCode)!==-1){e.preventDefault();e.stopPropagation()}},true);if(n.ENV.TOUCH_ENABLED){o.addEventListener("touchstart",function(e){var r=e.target.tagName.toLowerCase();if(n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1){e.preventDefault();if(!t.running){e.stopPropagation()}}},true);o.addEventListener("touchmove",function(e){var r=e.target.tagName.toLowerCase();if(n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1){e.preventDefault();if(!t.running){e.stopPropagation()}}},true);o.addEventListener("touchend",function(e){var r=e.target.tagName.toLowerCase();if(n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1){e.preventDefault();if(!t.running){e.stopPropagation()}}},true)}o.addEventListener("mousedown",function(e){var r=e.target.tagName.toLowerCase();if(n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1){e.preventDefault();t._mousedownID++;if(!t.running){e.stopPropagation()}}},true);o.addEventListener("mousemove",function(e){var r=e.target.tagName.toLowerCase();if(n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1){e.preventDefault();if(!t.running){e.stopPropagation()}}},true);o.addEventListener("mouseup",function(e){var r=e.target.tagName.toLowerCase();if(n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1){e.preventDefault();if(!t.running){e.stopPropagation()}}},true);t._touchEventTarget={};if(n.ENV.TOUCH_ENABLED){o.addEventListener("touchstart",function(e){var t=n.Core.instance;var r=new n.Event(n.Event.TOUCH_START);var i=e.changedTouches;var s,o;for(var u=0,a=i.length;u<a;u++){s=i[u];r._initPosition(s.pageX,s.pageY);o=t.currentScene._determineEventTarget(r);t._touchEventTarget[s.identifier]=o;o.dispatchEvent(r)}},false);o.addEventListener("touchmove",function(e){var t=n.Core.instance;var r=new n.Event(n.Event.TOUCH_MOVE);var i=e.changedTouches;var s,o;for(var u=0,a=i.length;u<a;u++){s=i[u];o=t._touchEventTarget[s.identifier];if(o){r._initPosition(s.pageX,s.pageY);o.dispatchEvent(r)}}},false);o.addEventListener("touchend",function(e){var t=n.Core.instance;var r=new n.Event(n.Event.TOUCH_END);var i=e.changedTouches;var s,o;for(var u=0,a=i.length;u<a;u++){s=i[u];o=t._touchEventTarget[s.identifier];if(o){r._initPosition(s.pageX,s.pageY);o.dispatchEvent(r);delete t._touchEventTarget[s.identifier]}}},false)}o.addEventListener("mousedown",function(e){var t=n.Core.instance;var r=new n.Event(n.Event.TOUCH_START);r._initPosition(e.pageX,e.pageY);var i=t.currentScene._determineEventTarget(r);t._touchEventTarget[t._mousedownID]=i;i.dispatchEvent(r)},false);o.addEventListener("mousemove",function(e){var t=n.Core.instance;var r=new n.Event(n.Event.TOUCH_MOVE);r._initPosition(e.pageX,e.pageY);var i=t._touchEventTarget[t._mousedownID];if(i){i.dispatchEvent(r)}},false);o.addEventListener("mouseup",function(e){var t=n.Core.instance;var r=new n.Event(n.Event.TOUCH_END);r._initPosition(e.pageX,e.pageY);var i=t._touchEventTarget[t._mousedownID];if(i){i.dispatchEvent(r)}delete t._touchEventTarget[t._mousedownID]},false)}},width:{get:function(){return this._width},set:function(e){this._width=e;this._dispatchCoreResizeEvent()}},height:{get:function(){return this._height},set:function(e){this._height=e;this._dispatchCoreResizeEvent()}},scale:{get:function(){return this._scale},set:function(e){this._scale=e;this._dispatchCoreResizeEvent()}},_dispatchCoreResizeEvent:function(){var e=new n.Event("coreresize");e.width=this._width;e.height=this._height;e.scale=this._scale;this.dispatchEvent(e)},_oncoreresize:function(e){this._element.style.width=Math.floor(this._width*this._scale)+"px";this._element.style.height=Math.floor(this._height*this._scale)+"px";var t;for(var n=0,r=this._scenes.length;n<r;n++){t=this._scenes[n];t.dispatchEvent(e)}},preload:function(e){var t;if(!(e instanceof Array)){if(typeof e==="object"){t=[];for(var n in e){if(e.hasOwnProperty(n)){t.push([e[n],n])}}e=t}else{e=Array.prototype.slice.call(arguments)}}Array.prototype.push.apply(this._assets,e);return this},load:function(e,r,i,s){var o;if(typeof arguments[1]==="string"){o=r;i=i||function(){};s=s||function(){}}else{o=e;var u=i;i=arguments[1]||function(){};s=u||function(){}}var a=n.Core.findExt(e);return n.Deferred.next(function(){var r=new n.Deferred;var u=function(e){r.call(e);i.call(this,e)};var f=function(e){r.fail(e);s.call(this,e)};if(n.Core._loadFuncs[a]){n.Core.instance.assets[o]=n.Core._loadFuncs[a](e,a,u,f)}else{var l=new XMLHttpRequest;l.open("GET",e,true);l.onreadystatechange=function(){if(l.readyState===4){if(l.status!==200&&l.status!==0){var r=new n.Event("error");r.message=l.status+": "+"Cannot load an asset: "+e;f.call(n.Core.instance,r)}var i=l.getResponseHeader("Content-Type")||"";if(i.match(/^image/)){t.assets[o]=n.Surface.load(e,u,f)}else if(i.match(/^audio/)){t.assets[o]=n.Sound.load(e,i,u,f)}else{t.assets[o]=l.responseText;u.call(n.Core.instance,new n.Event("load"))}}};l.send(null)}return r})},start:function(r){var i=function(){this.frame=0;this.removeEventListener("load",i)};this.addEventListener("load",i);this.currentTime=e.getTime();this.running=true;this.ready=true;if(!this._activated){this._activated=true;if(n.ENV.BROWSER==="mobilesafari"&&n.ENV.USE_WEBAUDIO&&n.ENV.USE_TOUCH_TO_START_SCENE){var s=new n.Deferred;var o=this._createTouchToStartScene();o.addEventListener(n.Event.TOUCH_START,function a(){this.removeEventListener(n.Event.TOUCH_START,a);var e=new n.WebAudioSound;e.buffer=n.WebAudioSound.audioContext.createBuffer(1,1,48e3);e.play();t.removeScene(o);t.start(s)},false);t.pushScene(o);return s}}this._requestNextFrame(0);var u=this._requestPreload().next(function(){n.Core.instance.loadingScene.dispatchEvent(new n.Event(n.Event.LOAD))});if(r){u.next(function(e){r.call(e)}).error(function(e){r.fail(e)})}return u},_requestPreload:function(){var e={};var r=0,i=0,s=function(){var e=new n.Event("progress");e.loaded=++r;e.total=i;t.loadingScene.dispatchEvent(e)};this._assets.reverse().forEach(function(t){var n,r;if(t instanceof Array){n=t[0];r=t[1]}else{n=r=t}if(!e[r]){e[r]=this.load(n,r,s);i++}},this);this.pushScene(this.loadingScene);return n.Deferred.parallel(e)},_createTouchToStartScene:function(){var e=new n.Label("Touch to Start"),r=Math.round(t.width/10),i=new n.Scene;e.color="#fff";e.font=r-1+"px bold Helvetica,Arial,sans-serif";e.textAlign="center";e.width=t.width;e.height=e._boundHeight;e.y=(t.height-e.height)/2;i.backgroundColor="#000";i.addChild(e);return i},debug:function(){this._debug=true;return this.start()},actualFps:{get:function(){return this._actualFps||this.fps}},_requestNextFrame:function(t){if(!this.ready){return}if(this.fps>=60||t<=16){this._calledTime=e.getTime();e.requestAnimationFrame(this._callTick)}else{setTimeout(function(){var t=n.Core.instance;t._calledTime=e.getTime();e.requestAnimationFrame(t._callTick)},Math.max(0,t))}},_callTick:function(e){n.Core.instance._tick(e)},_tick:function(t){var r=new n.Event("enterframe");var i=e.getTime();var s=r.elapsed=i-this.currentTime;this._actualFps=s>0?1e3/s:0;var o=this.currentScene.childNodes.slice();var u=Array.prototype.push;while(o.length){var a=o.pop();a.age++;a.dispatchEvent(r);if(a.childNodes){u.apply(o,a.childNodes)}}this.currentScene.age++;this.currentScene.dispatchEvent(r);this.dispatchEvent(r);this.dispatchEvent(new n.Event("exitframe"));this.frame++;i=e.getTime();this.currentTime=i;this._requestNextFrame(1e3/this.fps-(i-this._calledTime))},getTime:function(){return e.getTime()},stop:function(){this.ready=false;this.running=false},pause:function(){this.ready=false},resume:function(){if(this.ready){return}this.currentTime=e.getTime();this.ready=true;this.running=true;this._requestNextFrame(0)},pushScene:function(e){this._element.appendChild(e._element);if(this.currentScene){this.currentScene.dispatchEvent(new n.Event("exit"))}this.currentScene=e;this.currentScene.dispatchEvent(new n.Event("enter"));return this._scenes.push(e)},popScene:function(){if(this.currentScene===this.rootScene){return this.currentScene}this._element.removeChild(this.currentScene._element);this.currentScene.dispatchEvent(new n.Event("exit"));this.currentScene=this._scenes[this._scenes.length-2];this.currentScene.dispatchEvent(new n.Event("enter"));return this._scenes.pop()},replaceScene:function(e){this.popScene();return this.pushScene(e)},removeScene:function(e){if(this.currentScene===e){return this.popScene()}else{var t=this._scenes.indexOf(e);if(t!==-1){this._scenes.splice(t,1);this._element.removeChild(e._element);return e}else{return null}}},_buttonListener:function(e){this.currentScene.dispatchEvent(e)},keybind:function(e,t){this.keyboardInputManager.keybind(e,t);this.addEventListener(t+"buttondown",this._buttonListener);this.addEventListener(t+"buttonup",this._buttonListener);return this},keyunbind:function(e){var t=this._keybind[e];this.keyboardInputManager.keyunbind(e);this.removeEventListener(t+"buttondown",this._buttonListener);this.removeEventListener(t+"buttonup",this._buttonListener);return this},changeButtonState:function(e,t){this.keyboardInputManager.changeState(e,t)},getElapsedTime:function(){return this.frame/this.fps}});n.Core._loadFuncs={};n.Core._loadFuncs["jpg"]=n.Core._loadFuncs["jpeg"]=n.Core._loadFuncs["gif"]=n.Core._loadFuncs["png"]=n.Core._loadFuncs["bmp"]=function(e,t,r,i){return n.Surface.load(e,r,i)};n.Core._loadFuncs["mp3"]=n.Core._loadFuncs["aac"]=n.Core._loadFuncs["m4a"]=n.Core._loadFuncs["wav"]=n.Core._loadFuncs["ogg"]=function(e,t,r,i){return n.Sound.load(e,"audio/"+t,r,i)};n.Core.findExt=function(e){var t=e.match(/\.\w+$/);if(t&&t.length>0){return t[0].slice(1).toLowerCase()}if(e.indexOf("data:")===0){return e.split(/[\/;]/)[1].toLowerCase()}return null};n.Core.instance=null})();n.Game=n.Core;n.InputManager=n.Class.create(n.EventTarget,{initialize:function(e,t){n.EventTarget.call(this);this.broadcastTarget=[];this.valueStore=e;this.source=t||this;this._binds={};this._stateHandler=function(e){var t=e.source.identifier;var n=this._binds[t];this.changeState(n,e.data)}.bind(this)},bind:function(e,t){e.addEventListener(n.Event.INPUT_STATE_CHANGED,this._stateHandler);this._binds[e.identifier]=t},unbind:function(e){e.removeEventListener(n.Event.INPUT_STATE_CHANGED,this._stateHandler);delete this._binds[e.identifier]},addBroadcastTarget:function(e){var t=this.broadcastTarget.indexOf(e);if(t===-1){this.broadcastTarget.push(e)}},removeBroadcastTarget:function(e){var t=this.broadcastTarget.indexOf(e);if(t!==-1){this.broadcastTarget.splice(t,1)}},broadcastEvent:function(e){var t=this.broadcastTarget;for(var n=0,r=t.length;n<r;n++){t[n].dispatchEvent(e)}},changeState:function(e,t){}});n.InputSource=n.Class.create(n.EventTarget,{initialize:function(e){n.EventTarget.call(this);this.identifier=e},notifyStateChange:function(e){var t=new n.Event(n.Event.INPUT_STATE_CHANGED);t.data=e;t.source=this;this.dispatchEvent(t)}});n.BinaryInputManager=n.Class.create(n.InputManager,{initialize:function(e,t,r,i){n.InputManager.call(this,e,i);this.activeInputsNum=0;this.activeEventNameSuffix=t;this.inactiveEventNameSuffix=r},bind:function(e,t){n.InputManager.prototype.bind.call(this,e,t);this.valueStore[t]=false},unbind:function(e){var t=this._binds[e.identifier];n.InputManager.prototype.unbind.call(this,e);delete this.valueStore[t]},changeState:function(e,t){if(t){this._down(e)}else{this._up(e)}},_down:function(e){var t;if(!this.valueStore[e]){this.valueStore[e]=true;t=new n.Event(this.activeInputsNum++?"inputchange":"inputstart");t.source=this.source;this.broadcastEvent(t)}var r=new n.Event(e+this.activeEventNameSuffix);r.source=this.source;this.broadcastEvent(r)},_up:function(e){var t;if(this.valueStore[e]){this.valueStore[e]=false;t=new n.Event(--this.activeInputsNum?"inputchange":"inputend");t.source=this.source;this.broadcastEvent(t)}var r=new n.Event(e+this.inactiveEventNameSuffix);r.source=this.source;this.broadcastEvent(r)}});n.BinaryInputSource=n.Class.create(n.InputSource,{initialize:function(e){n.InputSource.call(this,e)}});n.KeyboardInputManager=n.Class.create(n.BinaryInputManager,{initialize:function(e,t){n.BinaryInputManager.call(this,t,"buttondown","buttonup");this._attachDOMEvent(e,"keydown",true);this._attachDOMEvent(e,"keyup",false)},keybind:function(e,t){this.bind(n.KeyboardInputSource.getByKeyCode(""+e),t)},keyunbind:function(e){this.unbind(n.KeyboardInputSource.getByKeyCode(""+e))},_attachDOMEvent:function(e,t,r){e.addEventListener(t,function(e){var t=n.Core.instance;if(!t||!t.running){return}var i=e.keyCode;var s=n.KeyboardInputSource._instances[i];if(s){s.notifyStateChange(r)}},true)}});n.KeyboardInputSource=n.Class.create(n.BinaryInputSource,{initialize:function(e){n.BinaryInputSource.call(this,e)}});n.KeyboardInputSource._instances={};n.KeyboardInputSource.getByKeyCode=function(e){if(!this._instances[e]){this._instances[e]=new n.KeyboardInputSource(e)}return this._instances[e]};n.Node=n.Class.create(n.EventTarget,{initialize:function(){n.EventTarget.call(this);this._dirty=false;this._matrix=[1,0,0,1,0,0];this._x=0;this._y=0;this._offsetX=0;this._offsetY=0;this.age=0;this.parentNode=null;this.scene=null;this.addEventListener("touchstart",function(e){if(this.parentNode){this.parentNode.dispatchEvent(e)}});this.addEventListener("touchmove",function(e){if(this.parentNode){this.parentNode.dispatchEvent(e)}});this.addEventListener("touchend",function(e){if(this.parentNode){this.parentNode.dispatchEvent(e)}});if(n.ENV.USE_ANIMATION){this.tl=new n.Timeline(this)}},moveTo:function(e,t){this._x=e;this._y=t;this._dirty=true},moveBy:function(e,t){this._x+=e;this._y+=t;this._dirty=true},x:{get:function(){return this._x},set:function(e){this._x=e;this._dirty=true}},y:{get:function(){return this._y},set:function(e){this._y=e;this._dirty=true}},_updateCoordinate:function(){var e=this;var t=[e];var r=e.parentNode;var i=this.scene;while(r&&e._dirty){t.unshift(r);e=e.parentNode;r=e.parentNode}var s=n.Matrix.instance;var o=s.stack;var u=[];var a,f,l;for(var c=0,h=t.length;c<h;c++){e=t[c];a=[];s.makeTransformMatrix(e,u);s.multiply(o[o.length-1],u,a);e._matrix=a;o.push(a);f=typeof e._originX==="number"?e._originX:e._width/2||0;l=typeof e._originY==="number"?e._originY:e._height/2||0;var p=[f,l];s.multiplyVec(a,p,p);e._offsetX=p[0]-f;e._offsetY=p[1]-l;e._dirty=false}s.reset()},remove:function(){if(this._listener){this.clearEventListener()}if(this.parentNode){this.parentNode.removeChild(this)}}});var r=function(e,t){var n=[];var r;for(var i=0,s=e.collection.length;i<s;i++){r=e.collection[i];if(t._intersectOne(r)){n.push(r)}}return n};var i=function(e,t){var n=[];var r,i;for(var s=0,o=e.collection.length;s<o;s++){r=e.collection[s];for(var u=0,a=t.collection.length;u<a;u++){i=t.collection[u];if(r._intersectOne(i)){n.push([r,i])}}}return n};var s=function(e,t){var n=[];var r;for(var i=0,s=e.collection.length;i<s;i++){r=e.collection[i];if(t._intersectStrictOne(r)){n.push(r)}}return n};var o=function(e,t){var n=[];var r,i;for(var s=0,o=e.collection.length;s<o;s++){r=e.collection[s];for(var u=0,a=t.collection.length;u<a;u++){i=t.collection[u];if(r._intersectStrictOne(i)){n.push([r,i])}}}return n};var u=function(e){if(e instanceof n.Entity){return r(this,e)}else if(typeof e==="function"&&e.collection){return i(this,e)}return false};var a=function(e){if(e instanceof n.Entity){return s(this,e)}else if(typeof e==="function"&&e.collection){return o(this,e)}return false};n.Entity=n.Class.create(n.Node,{initialize:function(){var e=n.Core.instance;n.Node.call(this);this._rotation=0;this._scaleX=1;this._scaleY=1;this._touchEnabled=true;this._clipping=false;this._originX=null;this._originY=null;this._width=0;this._height=0;this._backgroundColor=null;this._debugColor="#0000ff";this._opacity=1;this._visible=true;this._buttonMode=null;this._style={};this.__styleStatus={};this._isContainedInCollection=false;this.compositeOperation=null;this.buttonMode=null;this.buttonPressed=false;this.addEventListener("touchstart",function(){if(!this.buttonMode){return}this.buttonPressed=true;this.dispatchEvent(new n.Event(this.buttonMode+"buttondown"));e.changeButtonState(this.buttonMode,true)});this.addEventListener("touchend",function(){if(!this.buttonMode){return}this.buttonPressed=false;this.dispatchEvent(new n.Event(this.buttonMode+"buttonup"));e.changeButtonState(this.buttonMode,false)});this.enableCollection()},width:{get:function(){return this._width},set:function(e){this._width=e;this._dirty=true}},height:{get:function(){return this._height},set:function(e){this._height=e;this._dirty=true}},backgroundColor:{get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=e}},debugColor:{get:function(){return this._debugColor},set:function(e){this._debugColor=e}},opacity:{get:function(){return this._opacity},set:function(e){this._opacity=parseFloat(e)}},visible:{get:function(){return this._visible},set:function(e){this._visible=e}},touchEnabled:{get:function(){return this._touchEnabled},set:function(e){this._touchEnabled=e;if(e){this._style.pointerEvents="all"}else{this._style.pointerEvents="none"}}},intersect:function(e){if(e instanceof n.Entity){return this._intersectOne(e)}else if(typeof e==="function"&&e.collection){return r(e,this)}return false},_intersectOne:function(e){if(this._dirty){this._updateCoordinate()}if(e._dirty){e._updateCoordinate()}return this._offsetX<e._offsetX+e.width&&e._offsetX<this._offsetX+this.width&&this._offsetY<e._offsetY+e.height&&e._offsetY<this._offsetY+this.height},intersectStrict:function(e){if(e instanceof n.Entity){return this._intersectStrictOne(e)}else if(typeof e==="function"&&e.collection){return s(e,this)}return false},_intersectStrictOne:function(e){if(this._dirty){this._updateCoordinate()}if(e._dirty){e._updateCoordinate()}var t=this.getOrientedBoundingRect(),n=e.getOrientedBoundingRect(),r=t.leftTop,i=t.rightTop,s=t.leftBottom,o=t.rightBottom,u=n.leftTop,a=n.rightTop,f=n.leftBottom,l=n.rightBottom,c=r[0],h=r[1],p=i[0],d=i[1],v=s[0],m=s[1],g=o[0],y=o[1],b=u[0],w=u[1],E=a[0],S=a[1],x=f[0],T=f[1],N=l[0],C=l[1],k=[p-c,d-h],L=[g-p,y-d],A=[v-g,m-y],O=[c-v,h-m],M=[E-b,S-w],_=[N-E,C-S],D=[x-N,T-C],P=[b-x,w-T],H=c+p+v+g>>2,B=h+d+m+y>>2,j=b+E+x+N>>2,F=w+S+T+C>>2,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut;if(k[0]*(F-h)-k[1]*(j-c)>0&&L[0]*(F-d)-L[1]*(j-p)>0&&A[0]*(F-y)-A[1]*(j-g)>0&&O[0]*(F-m)-O[1]*(j-v)>0){return true}else if(M[0]*(B-w)-M[1]*(H-b)>0&&_[0]*(B-S)-_[1]*(H-E)>0&&D[0]*(B-C)-D[1]*(H-N)>0&&P[0]*(B-T)-P[1]*(H-x)>0){return true}else{R=[r,i,o,s];U=[u,a,l,f];z=[k,L,A,O];W=[M,_,D,P];for(I=0;I<4;I++){X=R[I];K=X[0];Q=X[1];$=z[I];Z=$[0];et=$[1];for(q=0;q<4;q++){V=U[q];G=V[0];Y=V[1];J=W[q];tt=J[0];nt=J[1];st=Z*nt-et*tt;if(st!==0){rt=G-K;it=Y-Q;ot=(rt*et-it*Z)/st;ut=(rt*nt-it*tt)/st;if(0<ot&&ot<1&&0<ut&&ut<1){return true}}}}return false}},within:function(e,t){if(this._dirty){this._updateCoordinate()}if(e._dirty){e._updateCoordinate()}if(t==null){t=(this.width+this.height+e.width+e.height)/4}var n;return(n=this._offsetX-e._offsetX+(this.width-e.width)/2)*n+(n=this._offsetY-e._offsetY+(this.height-e.height)/2)*n<t*t},scale:function(e,t){this._scaleX*=e;this._scaleY*=t!=null?t:e;this._dirty=true},rotate:function(e){this._rotation+=e;this._dirty=true},scaleX:{get:function(){return this._scaleX},set:function(e){this._scaleX=e;this._dirty=true}},scaleY:{get:function(){return this._scaleY},set:function(e){this._scaleY=e;this._dirty=true}},rotation:{get:function(){return this._rotation},set:function(e){this._rotation=e;this._dirty=true}},originX:{get:function(){return this._originX},set:function(e){this._originX=e;this._dirty=true}},originY:{get:function(){return this._originY},set:function(e){this._originY=e;this._dirty=true}},enableCollection:function(){this.addEventListener("addedtoscene",this._addSelfToCollection);this.addEventListener("removedfromscene",this._removeSelfFromCollection);if(this.scene){this._addSelfToCollection()}},disableCollection:function(){this.removeEventListener("addedtoscene",this._addSelfToCollection);this.removeEventListener("removedfromscene",this._removeSelfFromCollection);if(this.scene){this._removeSelfFromCollection()}},_addSelfToCollection:function(){if(this._isContainedInCollection){return}var e=this.getConstructor();e._collectionTarget.forEach(function(e){e.collection.push(this)},this);this._isContainedInCollection=true},_removeSelfFromCollection:function(){if(!this._isContainedInCollection){return}var e=this.getConstructor();e._collectionTarget.forEach(function(e){var t=e.collection.indexOf(this);if(t!==-1){e.collection.splice(t,1)}},this);this._isContainedInCollection=false},getBoundingRect:function(){var e=this.width||0;var t=this.height||0;var n=this._matrix;var r=n[0]*e,i=n[1]*e,s=n[2]*t,o=n[3]*t,u=n[4],a=n[5];var f=[u,r+u,s+u,r+s+u].sort(function(e,t){return e-t});var l=[a,i+a,o+a,i+o+a].sort(function(e,t){return e-t});return{left:f[0],top:l[0],width:f[3]-f[0],height:l[3]-l[0]}},getOrientedBoundingRect:function(){var e=this.width||0;var t=this.height||0;var n=this._matrix;var r=n[0]*e,i=n[1]*e,s=n[2]*t,o=n[3]*t,u=n[4],a=n[5];return{leftTop:[u,a],rightTop:[r+u,i+a],leftBottom:[s+u,o+a],rightBottom:[r+s+u,i+o+a]}},getConstructor:function(){return Object.getPrototypeOf(this).constructor}});var f=function(e){if(e._collective){return}var t=n.Class.getInheritanceTree(e);var r=t.indexOf(n.Entity);if(r!==-1){e._collectionTarget=t.splice(0,r+1)}else{e._collectionTarget=[]}e.intersect=u;e.intersectStrict=a;e.collection=[];e._collective=true};f(n.Entity);n.Entity._inherited=function(e){f(e)};n.Sprite=n.Class.create(n.Entity,{initialize:function(e,t){n.Entity.call(this);this.width=e;this.height=t;this._image=null;this._debugColor="#ff0000";this._frameLeft=0;this._frameTop=0;this._frame=0;this._frameSequence=[];this.addEventListener(n.Event.ENTER_FRAME,this._rotateFrameSequence)},image:{get:function(){return this._image},set:function(e){if(e===t){throw new Error("Assigned value on Sprite.image is undefined. Please double-check image path, and check if the image you want to use is preload before use.")}if(e===this._image){return}this._image=e;this._computeFramePosition()}},frame:{get:function(){return this._frame},set:function(e){if(this._frame===e||e instanceof Array&&this._deepCompareToPreviousFrame(e)){return}if(e instanceof Array){this._frameSequence=e.slice();this._originalFrameSequence=e.slice();this._rotateFrameSequence()}else{this._frameSequence=[];this._frame=e;this._computeFramePosition()}}},_deepCompareToPreviousFrame:function(e){if(e===this._originalFrameSequence){return true}if(e==null||this._originalFrameSequence==null){return false}if(e.length!==this._originalFrameSequence.length){return false}for(var t=0;t<e.length;++t){if(e[t]!==this._originalFrameSequence[t]){return false}}return true},_computeFramePosition:function(){var e=this._image;var t;if(e!=null){t=e.width/this._width|0;this._frameLeft=(this._frame%t|0)*this._width;this._frameTop=(this._frame/t|0)*this._height%e.height}},_rotateFrameSequence:function(){if(this._frameSequence.length!==0){var e=this._frameSequence.shift();if(e===null){this._frameSequence=[];this.dispatchEvent(new n.Event(n.Event.ANIMATION_END))}else{this._frame=e;this._computeFramePosition();this._frameSequence.push(e)}}},width:{get:function(){return this._width},set:function(e){this._width=e;this._computeFramePosition();this._dirty=true}},height:{get:function(){return this._height},set:function(e){this._height=e;this._computeFramePosition();this._dirty=true}},cvsRender:function(e){var t=this._image,r=this._width,i=this._height,s,o,u,a,f,l,c;if(t&&r!==0&&i!==0){s=t.width,o=t.height;if(s<r||o<i){e.fillStyle=n.Surface._getPattern(t);e.fillRect(0,0,r,i)}else{u=t._element;a=this._frameLeft;f=Math.min(this._frameTop,o-i);l=Math.max(.01,Math.min(s-a,r));c=Math.max(.01,Math.min(o-f,i));e.drawImage(u,a,f,l,c,0,0,r,i)}}},domRender:function(){if(n.ENV.VENDOR_PREFIX==="ms"){return function(e){if(this._image){if(this._image._css){this._style["background-image"]=this._image._css;this._style["background-position"]=-this._frameLeft+"px "+ -this._frameTop+"px"}else if(this._image._element){}}}}else{return function(e){if(this._image){if(this._image._css){this._style["background-image"]=this._image._css;this._style["background-position"]=-this._frameLeft+"px "+ -this._frameTop+"px"}else if(this._image._element){}}}}}()});n.Label=n.Class.create(n.Entity,{initialize:function(e){n.Entity.call(this);this.text=e||"";this.width=300;this.font="14px serif";this.textAlign="left";this._debugColor="#ff0000"},width:{get:function(){return this._width},set:function(e){this._width=e;this._dirty=true;this.updateBoundArea()}},text:{get:function(){return this._text},set:function(e){e=""+e;if(this._text===e){return}this._text=e;e=e.replace(/<(br|BR) ?\/?>/g,"<br/>");this._splitText=e.split("<br/>");this.updateBoundArea();for(var t=0,n=this._splitText.length;t<n;t++){e=this._splitText[t];var r=this.getMetrics(e);this._splitText[t]={};this._splitText[t].text=e;this._splitText[t].height=r.height}}},textAlign:{get:function(){return this._style["text-align"]},set:function(e){this._style["text-align"]=e;this.updateBoundArea()}},font:{get:function(){return this._style.font},set:function(e){this._style.font=e;this.updateBoundArea()}},color:{get:function(){return this._style.color},set:function(e){this._style.color=e}},cvsRender:function(e){var t,n=0;var r=this.width;var i,s,o,u,a,f,l,c;var h;if(this._splitText){e.textBaseline="top";e.font=this.font;e.fillStyle=this.color||"#000000";i=e.measureText(" ").width;s=r/i;for(var p=0,d=this._splitText.length;p<d;p++){o=this._splitText[p];u=o.text;a=0;while(u.length>a+s||e.measureText(u.slice(a,a+s)).width>r){f="";l=s;c=0;while(l>0){if(e.measureText(f).width<r){c+=l;f=u.slice(a,a+c)}else{c-=l;f=u.slice(a,a+c)}l=l/2|0}e.fillText(f,0,n);n+=o.height-1;a+=c}f=u.slice(a,a+u.length);if(this.textAlign==="right"){t=r-e.measureText(f).width}else if(this.textAlign==="center"){t=(r-e.measureText(f).width)/2}else{t=0}e.fillText(f,t,n);n+=o.height-1}}},domRender:function(e){if(e.innerHTML!==this._text){e.innerHTML=this._text}},detectRender:function(e){e.fillRect(this._boundOffset,0,this._boundWidth,this._boundHeight)},updateBoundArea:function(){var e=this.getMetrics();this._boundWidth=e.width;this._boundHeight=e.height;if(this.textAlign==="right"){this._boundOffset=this.width-this._boundWidth}else if(this.textAlign==="center"){this._boundOffset=(this.width-this._boundWidth)/2}else{this._boundOffset=0}},getMetrics:function(e){var t={};var n,r,i;if(document.body){n=document.createElement("div");for(var s in this._style){if(s!=="width"&&s!=="height"){n.style[s]=this._style[s]}}e=e||this._text;n.innerHTML=e.replace(/ /g,"&nbsp;");n.style.whiteSpace="noWrap";n.style.lineHeight=1;document.body.appendChild(n);t.height=parseInt(getComputedStyle(n).height,10)+1;n.style.position="absolute";t.width=parseInt(getComputedStyle(n).width,10)+1;document.body.removeChild(n)}else{t.width=this.width;t.height=this.height}return t}});n.Map=n.Class.create(n.Entity,{initialize:function(e,t){var r=n.Core.instance;n.Entity.call(this);var i=new n.Surface(r.width,r.height);this._surface=i;var s=i._element;s.style.position="absolute";if(n.ENV.RETINA_DISPLAY&&r.scale===2){s.width=r.width*2;s.height=r.height*2;this._style.webkitTransformOrigin="0 0";this._style.webkitTransform="scale(0.5)"}else{s.width=r.width;s.height=r.height}this._context=s.getContext("2d");this._tileWidth=e||0;this._tileHeight=t||0;this._image=null;this._data=[[[]]];this._dirty=false;this._tight=false;this.touchEnabled=false;this.collisionData=null;this._listeners["render"]=null;this.addEventListener("render",function(){if(this._dirty||this._previousOffsetX==null){this.redraw(0,0,r.width,r.height)}else if(this._offsetX!==this._previousOffsetX||this._offsetY!==this._previousOffsetY){if(this._tight){var e=-this._offsetX;var t=-this._offsetY;var n=-this._previousOffsetX;var i=-this._previousOffsetY;var s=e-n+r.width;var o=n-e+r.width;var u=t-i+r.height;var a=i-t+r.height;if(s>this._tileWidth&&o>this._tileWidth&&u>this._tileHeight&&a>this._tileHeight){var f,l,c,h,p,d;if(s<o){f=0;c=n-e;p=s}else{f=e-n;c=0;p=o}if(u<a){l=0;h=i-t;d=u}else{l=t-i;h=0;d=a}if(r._buffer==null){r._buffer=document.createElement("canvas");r._buffer.width=this._context.canvas.width;r._buffer.height=this._context.canvas.height}var v=r._buffer.getContext("2d");if(this._doubledImage){v.clearRect(0,0,p*2,d*2);v.drawImage(this._context.canvas,f*2,l*2,p*2,d*2,0,0,p*2,d*2);v=this._context;v.clearRect(c*2,h*2,p*2,d*2);v.drawImage(r._buffer,0,0,p*2,d*2,c*2,h*2,p*2,d*2)}else{v.clearRect(0,0,p,d);v.drawImage(this._context.canvas,f,l,p,d,0,0,p,d);v=this._context;v.clearRect(c,h,p,d);v.drawImage(r._buffer,0,0,p,d,c,h,p,d)}if(c===0){this.redraw(p,0,r.width-p,r.height)}else{this.redraw(0,0,r.width-p,r.height)}if(h===0){this.redraw(0,d,r.width,r.height-d)}else{this.redraw(0,0,r.width,r.height-d)}}else{this.redraw(0,0,r.width,r.height)}}else{this.redraw(0,0,r.width,r.height)}}this._previousOffsetX=this._offsetX;this._previousOffsetY=this._offsetY})},loadData:function(e){this._data=Array.prototype.slice.apply(arguments);this._dirty=true;this._tight=false;for(var t=0,n=this._data.length;t<n;t++){var r=0;e=this._data[t];for(var i=0,s=e.length;i<s;i++){for(var o=0,u=e[i].length;o<u;o++){if(e[i][o]>=0){r++}}}if(r/(e.length*e[0].length)>.2){this._tight=true;break}}},checkTile:function(e,t){if(e<0||this.width<=e||t<0||this.height<=t){return false}var n=this._image.width;var r=this._image.height;var i=this._tileWidth||n;var s=this._tileHeight||r;e=e/i|0;t=t/s|0;var o=this._data[0];return o[t][e]},hitTest:function(e,t){if(e<0||this.width<=e||t<0||this.height<=t){return false}var n=this._image.width;var r=this._image.height;var i=this._tileWidth||n;var s=this._tileHeight||r;e=e/i|0;t=t/s|0;if(this.collisionData!=null){return this.collisionData[t]&&!!this.collisionData[t][e]}else{for(var o=0,u=this._data.length;o<u;o++){var a=this._data[o];var f;if(a[t]!=null&&(f=a[t][e])!=null&&0<=f&&f<(n/i|0)*(r/s|0)){return true}}return false}},image:{get:function(){return this._image},set:function(e){var t=n.Core.instance;this._image=e;if(n.ENV.RETINA_DISPLAY&&t.scale===2){var r=new n.Surface(e.width*2,e.height*2);var i=this._tileWidth||e.width;var s=this._tileHeight||e.height;var o=e.width/i|0;var u=e.height/s|0;for(var a=0;a<u;a++){for(var f=0;f<o;f++){r.draw(e,f*i,a*s,i,s,f*i*2,a*s*2,i*2,s*2)}}this._doubledImage=r}this._dirty=true}},tileWidth:{get:function(){return this._tileWidth},set:function(e){this._tileWidth=e;this._dirty=true}},tileHeight:{get:function(){return this._tileHeight},set:function(e){this._tileHeight=e;this._dirty=true}},width:{get:function(){return this._tileWidth*this._data[0][0].length}},height:{get:function(){return this._tileHeight*this._data[0].length}},redraw:function(e,t,n,r){if(this._image==null){return}var i,s,o,u,a;if(this._doubledImage){i=this._doubledImage;s=this._tileWidth*2;o=this._tileHeight*2;u=-this._offsetX*2;a=-this._offsetY*2;e*=2;t*=2;n*=2;r*=2}else{i=this._image;s=this._tileWidth;o=this._tileHeight;u=-this._offsetX;a=-this._offsetY}var f=i.width/s|0;var l=i.height/o|0;var c=Math.max((e+u)/s|0,0);var h=Math.max((t+a)/o|0,0);var p=Math.ceil((e+u+n)/s);var d=Math.ceil((t+a+r)/o);var v=i._element;var m=this._context;var g=m.canvas;m.clearRect(e,t,n,r);for(var y=0,b=this._data.length;y<b;y++){var w=this._data[y];var E=Math.min(p,w[0].length);var S=Math.min(d,w.length);for(t=h;t<S;t++){for(e=c;e<E;e++){var x=w[t][e];if(0<=x&&x<f*l){var T=x%f*s;var N=(x/f|0)*o;m.drawImage(v,T,N,s,o,e*s-u,t*o-a,s,o)}}}}},cvsRender:function(e){var t=n.Core.instance;if(this.width!==0&&this.height!==0){e.save();e.setTransform(1,0,0,1,0,0);var r=this._context.canvas;e.drawImage(r,0,0,t.width,t.height);e.restore()}},domRender:function(e){if(this._image){this._style["background-image"]=this._surface._css;this._style[n.ENV.VENDOR_PREFIX+"Transform"]="matrix(1, 0, 0, 1, 0, 0)"}}});n.Group=n.Class.create(n.Node,{initialize:function(){this.childNodes=[];n.Node.call(this);this._rotation=0;this._scaleX=1;this._scaleY=1;this._originX=null;this._originY=null;this.__dirty=false;[n.Event.ADDED_TO_SCENE,n.Event.REMOVED_FROM_SCENE].forEach(function(e){this.addEventListener(e,function(e){this.childNodes.forEach(function(t){t.scene=this.scene;t.dispatchEvent(e)},this)})},this)},addChild:function(e){if(e.parentNode){e.parentNode.removeChild(e)}this.childNodes.push(e);e.parentNode=this;var t=new n.Event("childadded");t.node=e;t.next=null;this.dispatchEvent(t);e.dispatchEvent(new n.Event("added"));if(this.scene){e.scene=this.scene;var r=new n.Event("addedtoscene");e.dispatchEvent(r)}},insertBefore:function(e,t){if(e.parentNode){e.parentNode.removeChild(e)}var r=this.childNodes.indexOf(t);if(r!==-1){this.childNodes.splice(r,0,e);e.parentNode=this;var i=new n.Event("childadded");i.node=e;i.next=t;this.dispatchEvent(i);e.dispatchEvent(new n.Event("added"));if(this.scene){e.scene=this.scene;var s=new n.Event("addedtoscene");e.dispatchEvent(s)}}else{this.addChild(e)}},removeChild:function(e){var t;if((t=this.childNodes.indexOf(e))!==-1){this.childNodes.splice(t,1);e.parentNode=null;var r=new n.Event("childremoved");r.node=e;this.dispatchEvent(r);e.dispatchEvent(new n.Event("removed"));if(this.scene){e.scene=null;var i=new n.Event("removedfromscene");e.dispatchEvent(i)}}},firstChild:{get:function(){return this.childNodes[0]}},lastChild:{get:function(){return this.childNodes[this.childNodes.length-1]}},rotation:{get:function(){return this._rotation},set:function(e){this._rotation=e;this._dirty=true}},scaleX:{get:function(){return this._scaleX},set:function(e){this._scaleX=e;this._dirty=true}},scaleY:{get:function(){return this._scaleY},set:function(e){this._scaleY=e;this._dirty=true}},originX:{get:function(){return this._originX},set:function(e){this._originX=e;this._dirty=true}},originY:{get:function(){return this._originY},set:function(e){this._originY=e;this._dirty=true}},_dirty:{get:function(){return this.__dirty},set:function(e){e=!!e;this.__dirty=e;if(e){for(var t=0,n=this.childNodes.length;t<n;t++){this.childNodes[t]._dirty=true}}}}});n.Matrix=n.Class.create({initialize:function(){this.reset()},reset:function(){this.stack=[];this.stack.push([1,0,0,1,0,0])},makeTransformMatrix:function(e,t){var n=e._x;var r=e._y;var i=e.width||0;var s=e.height||0;var o=e._rotation||0;var u=typeof e._scaleX==="number"?e._scaleX:1;var a=typeof e._scaleY==="number"?e._scaleY:1;var f=o*Math.PI/180;var l=Math.cos(f);var c=Math.sin(f);var h=typeof e._originX==="number"?e._originX:i/2;var p=typeof e._originY==="number"?e._originY:s/2;var d=u*l;var v=u*c;var m=a*c;var g=a*l;t[0]=d;t[1]=v;t[2]=-m;t[3]=g;t[4]=-d*h+m*p+n+h;t[5]=-v*h-g*p+r+p},multiply:function(e,t,n){var r=e[0],i=e[2],s=e[4],o=e[1],u=e[3],a=e[5];var f=t[0],l=t[2],c=t[4],h=t[1],p=t[3],d=t[5];n[0]=r*f+i*h;n[1]=o*f+u*h;n[2]=r*l+i*p;n[3]=o*l+u*p;n[4]=r*c+i*d+s;n[5]=o*c+u*d+a},multiplyVec:function(e,t,n){var r=t[0],i=t[1];var s=e[0],o=e[2],u=e[4],a=e[1],f=e[3],l=e[5];n[0]=s*r+o*i+u;n[1]=a*r+f*i+l}});n.Matrix.instance=new n.Matrix;n.DetectColorManager=n.Class.create({initialize:function(e,t){this.reference=[];this.colorResolution=e||16;this.max=t||1;this.capacity=Math.pow(this.colorResolution,3);for(var n=1,r=this.capacity;n<r;n++){this.reference[n]=null}},attachDetectColor:function(e){var t=this.reference.indexOf(null);if(t===-1){t=1}this.reference[t]=e;return this._getColor(t)},detachDetectColor:function(e){var t=this.reference.indexOf(e);if(t!==-1){this.reference[t]=null}},_getColor:function(e){var t=this.colorResolution;var n=t/this.max;return[parseInt(e/t/t%t,10)/n,parseInt(e/t%t,10)/n,parseInt(e%t,10)/n,1]},_decodeDetectColor:function(e){var t=this.colorResolution;return~~(e[0]*t*t*t/256)+~~(e[1]*t*t/256)+~~(e[2]*t/256)},getSpriteByColor:function(e){return this.reference[this._decodeDetectColor(e)]}});n.DomManager=n.Class.create({initialize:function(e,t){var r=n.Core.instance;this.layer=null;this.targetNode=e;if(typeof t==="string"){this.element=document.createElement(t)}else if(t instanceof HTMLElement){this.element=t}this.style=this.element.style;this.style.position="absolute";this.style[n.ENV.VENDOR_PREFIX+"TransformOrigin"]="0px 0px";if(r._debug){this.style.border="1px solid blue";this.style.margin="-1px"}var i=this;this._setDomTarget=function(){i.layer._touchEventTarget=i.targetNode};this._attachEvent()},getDomElement:function(){return this.element},getDomElementAsNext:function(){return this.element},getNextManager:function(e){var t=this.targetNode.parentNode.childNodes.indexOf(e.targetNode);if(t!==this.targetNode.parentNode.childNodes.length-1){return this.targetNode.parentNode.childNodes[t+1]._domManager}else{return null}},addManager:function(e,t){var n;if(t){n=t.getDomElementAsNext()}var r=e.getDomElement();if(r instanceof Array){r.forEach(function(e){if(n){this.element.insertBefore(e,n)}else{this.element.appendChild(e)}},this)}else{if(n){this.element.insertBefore(r,n)}else{this.element.appendChild(r)}}this.setLayer(this.layer)},removeManager:function(e){if(e instanceof n.DomlessManager){e._domRef.forEach(function(e){this.element.removeChild(e)},this)}else{this.element.removeChild(e.element)}this.setLayer(this.layer)},setLayer:function(e){this.layer=e;var t=this.targetNode;var n;if(t.childNodes){for(var r=0,i=t.childNodes.length;r<i;r++){n=t.childNodes[r]._domManager;if(n){n.setLayer(e)}}}},render:function(e){var t=this.targetNode;var r=n.Matrix.instance;var i=r.stack;var s=[];r.makeTransformMatrix(t,s);r.multiply(i[i.length-1],s,s);r.multiply(e,s,e);t._matrix=e;var o=typeof t._originX==="number"?t._originX:t.width/2||0;var u=typeof t._originY==="number"?t._originY:t.height/2||0;var a=[o,u];r.multiplyVec(s,a,a);t._offsetX=a[0]-o;t._offsetY=a[1]-u;if(t.parentNode&&!(t.parentNode instanceof n.Group)){t._offsetX+=t.parentNode._offsetX;t._offsetY+=t.parentNode._offsetY}if(t._dirty){this.style[n.ENV.VENDOR_PREFIX+"Transform"]="matrix("+s[0].toFixed(10)+","+s[1].toFixed(10)+","+s[2].toFixed(10)+","+s[3].toFixed(10)+","+s[4].toFixed(10)+","+s[5].toFixed(10)+")"}this.domRender()},domRender:function(){var e=this.targetNode;if(!e._style){e._style={}}if(!e.__styleStatus){e.__styleStatus={}}if(e.width!==null){e._style.width=e.width+"px"}if(e.height!==null){e._style.height=e.height+"px"}e._style.opacity=e._opacity;e._style["background-color"]=e._backgroundColor;if(typeof e._visible!=="undefined"){e._style.display=e._visible?"block":"none"}if(typeof e.domRender==="function"){e.domRender(this.element)}var t;for(var n in e._style){t=e._style[n];if(e.__styleStatus[n]!==t&&t!=null){this.style.setProperty(n,""+t);e.__styleStatus[n]=t}}},_attachEvent:function(){if(n.ENV.TOUCH_ENABLED){this.element.addEventListener("touchstart",this._setDomTarget,true)}this.element.addEventListener("mousedown",this._setDomTarget,true)},_detachEvent:function(){if(n.ENV.TOUCH_ENABLED){this.element.removeEventListener("touchstart",this._setDomTarget,true)}this.element.removeEventListener("mousedown",this._setDomTarget,true)},remove:function(){this._detachEvent();this.element=this.style=this.targetNode=null}});n.DomlessManager=n.Class.create({initialize:function(e){this._domRef=[];this.targetNode=e},_register:function(e,t){var n=this._domRef.indexOf(t);var r;if(e instanceof Array){if(n===-1){Array.prototype.push.apply(this._domRef,e)}else{Array.prototype.splice.apply(this._domRef,[n,0].concat(e))}}else{if(n===-1){this._domRef.push(e)}else{this._domRef.splice(n,0,e)}}},getNextManager:function(e){var t=this.targetNode.parentNode.childNodes.indexOf(e.targetNode);if(t!==this.targetNode.parentNode.childNodes.length-1){return this.targetNode.parentNode.childNodes[t+1]._domManager}else{return null}},getDomElement:function(){var e=[];this.targetNode.childNodes.forEach(function(t){e=e.concat(t._domManager.getDomElement())});return e},getDomElementAsNext:function(){if(this._domRef.length){return this._domRef[0]}else{var e=this.getNextManager(this);if(e){return e.element}else{return null}}},addManager:function(e,t){var r=this.targetNode.parentNode;if(r){if(t===null){t=this.getNextManager(this)}if(r instanceof n.Scene){r._layers.Dom._domManager.addManager(e,t)}else{r._domManager.addManager(e,t)}}var i=t?t.getDomElementAsNext():null;this._register(e.getDomElement(),i);this.setLayer(this.layer)},removeManager:function(e){var t;var n=this._domRef.indexOf(e.element);if(n!==-1){t=this._domRef[n];t.parentNode.removeChild(t);this._domRef.splice(n,1)}this.setLayer(this.layer)},setLayer:function(e){this.layer=e;var t=this.targetNode;var n;if(t.childNodes){for(var r=0,i=t.childNodes.length;r<i;r++){n=t.childNodes[r]._domManager;if(n){n.setLayer(e)}}}},render:function(e){var t=n.Matrix.instance;var r=t.stack;var i=this.targetNode;var s=[];t.makeTransformMatrix(i,s);t.multiply(r[r.length-1],s,s);t.multiply(e,s,e);i._matrix=e;var o=typeof i._originX==="number"?i._originX:i.width/2||0;var u=typeof i._originY==="number"?i._originY:i.height/2||0;var a=[o,u];t.multiplyVec(s,a,a);i._offsetX=a[0]-o;i._offsetY=a[1]-u;r.push(s)},remove:function(){this._domRef=[];this.targetNode=null}});n.DomLayer=n.Class.create(n.Group,{initialize:function(){var e=n.Core.instance;n.Group.call(this);this._touchEventTarget=null;this._element=document.createElement("div");this._element.style.position="absolute";this._domManager=new n.DomManager(this,this._element);this._domManager.layer=this;this.width=e.width;this.height=e.height;var t=[n.Event.TOUCH_START,n.Event.TOUCH_MOVE,n.Event.TOUCH_END];t.forEach(function(e){this.addEventListener(e,function(e){if(this._scene){this._scene.dispatchEvent(e)}})},this);var r=function(e){var t=e.node;var s=e.next;var o=e.target;var u=s?s._domManager:null;n.DomLayer._attachDomManager(t,r,i);o._domManager.addManager(t._domManager,u);var a=new n.Event(n.Event.RENDER);t._dirty=true;o._domManager.layer._rendering(t,a)};var i=function(e){var t=e.node;var s=e.target;s._domManager.removeManager(t._domManager);n.DomLayer._detachDomManager(t,r,i)};this.addEventListener("childremoved",i);this.addEventListener("childadded",r)},width:{get:function(){return this._width},set:function(e){this._width=e;this._element.style.width=e+"px"}},height:{get:function(){return this._height},set:function(e){this._height=e;this._element.style.height=e+"px"}},addChild:function(e){this.childNodes.push(e);e.parentNode=this;var t=new n.Event("childadded");t.node=e;t.next=null;this.dispatchEvent(t);e.dispatchEvent(new n.Event("added"));if(this.scene){e.scene=this.scene;var r=new n.Event("addedtoscene");e.dispatchEvent(r)}},insertBefore:function(e,t){var r=this.childNodes.indexOf(t);if(r!==-1){this.childNodes.splice(r,0,e);e.parentNode=this;var i=new n.Event("childadded");i.node=e;i.next=t;this.dispatchEvent(i);e.dispatchEvent(new n.Event("added"));if(this.scene){e.scene=this.scene;var s=new n.Event("addedtoscene");e.dispatchEvent(s)}}else{this.addChild(e)}},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe);this._onexitframe()},_stopRendering:function(){this.removeEventListener("exitframe",this._onexitframe);this._onexitframe()},_onexitframe:function(){this._rendering(this,new n.Event(n.Event.RENDER))},_rendering:function(e,t,r){var i;if(!r){r=[1,0,0,1,0,0]}e.dispatchEvent(t);e._domManager.render(r);if(e.childNodes){for(var s=0,o=e.childNodes.length;s<o;s++){i=e.childNodes[s];this._rendering(i,t,r.slice())}}if(e._domManager instanceof n.DomlessManager){n.Matrix.instance.stack.pop()}e._dirty=false},_determineEventTarget:function(){var e=this._touchEventTarget;this._touchEventTarget=null;return e===this?null:e}});n.DomLayer._attachDomManager=function(e,t,r){var i;if(!e._domManager){e.addEventListener("childadded",t);e.addEventListener("childremoved",r);if(e instanceof n.Group){e._domManager=new n.DomlessManager(e)}else{if(e._element){e._domManager=new n.DomManager(e,e._element)}else{e._domManager=new n.DomManager(e,"div")}}}if(e.childNodes){for(var s=0,o=e.childNodes.length;s<o;s++){i=e.childNodes[s];n.DomLayer._attachDomManager(i,t,r);e._domManager.addManager(i._domManager,null)}}};n.DomLayer._detachDomManager=function(e,t,r){var i;e.removeEventListener("childadded",t);e.removeEventListener("childremoved",r);if(e.childNodes){for(var s=0,o=e.childNodes.length;s<o;s++){i=e.childNodes[s];e._domManager.removeManager(i._domManager,null);n.DomLayer._detachDomManager(i,t,r)}}e._domManager.remove();delete e._domManager};n.CanvasLayer=n.Class.create(n.Group,{initialize:function(){var e=n.Core.instance;n.Group.call(this);this._cvsCache={matrix:[1,0,0,1,0,0],detectColor:"#000000"};this._cvsCache.layer=this;this._element=document.createElement("canvas");this._element.style.position="absolute";this._element.style.left=this._element.style.top="0px";this._detect=document.createElement("canvas");this._detect.style.position="absolute";this._lastDetected=0;this.context=this._element.getContext("2d");this._dctx=this._detect.getContext("2d");this._colorManager=new n.DetectColorManager(16,256);this.width=e.width;this.height=e.height;var t=[n.Event.TOUCH_START,n.Event.TOUCH_MOVE,n.Event.TOUCH_END];t.forEach(function(e){this.addEventListener(e,function(e){if(this._scene){this._scene.dispatchEvent(e)}})},this);var r=function(e){var t=e.node;var s=e.target;var o;if(s instanceof n.CanvasLayer){o=s._scene._layers.Canvas}else{o=s.scene._layers.Canvas}n.CanvasLayer._attachCache(t,o,r,i);var u=new n.Event(n.Event.RENDER);if(s._dirty){s._updateCoordinate()}t._dirty=true;n.Matrix.instance.stack.push(s._matrix);n.CanvasRenderer.instance.render(o.context,t,u);n.Matrix.instance.stack.pop(s._matrix)};var i=function(e){var t=e.node;var s=e.target;var o;if(s instanceof n.CanvasLayer){o=s._scene._layers.Canvas}else{o=s.scene._layers.Canvas}n.CanvasLayer._detachCache(t,o,r,i)};this.addEventListener("childremoved",i);this.addEventListener("childadded",r)},width:{get:function(){return this._width},set:function(e){this._width=e;this._element.width=this._detect.width=e}},height:{get:function(){return this._height},set:function(e){this._height=e;this._element.height=this._detect.height=e}},addChild:function(e){this.childNodes.push(e);e.parentNode=this;var t=new n.Event("childadded");t.node=e;t.next=null;this.dispatchEvent(t);e.dispatchEvent(new n.Event("added"));if(this.scene){e.scene=this.scene;var r=new n.Event("addedtoscene");e.dispatchEvent(r)}},insertBefore:function(e,t){var r=this.childNodes.indexOf(t);if(r!==-1){this.childNodes.splice(r,0,e);e.parentNode=this;var i=new n.Event("childadded");i.node=e;i.next=t;this.dispatchEvent(i);e.dispatchEvent(new n.Event("added"));if(this.scene){e.scene=this.scene;var s=new n.Event("addedtoscene");e.dispatchEvent(s)}}else{this.addChild(e)}},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe);this._onexitframe(new n.Event(n.Event.RENDER))},_stopRendering:function(){this.removeEventListener("render",this._onexitframe);this._onexitframe(new n.Event(n.Event.RENDER))},_onexitframe:function(){var e=n.Core.instance;var t=this.context;t.clearRect(0,0,e.width,e.height);var r=new n.Event(n.Event.RENDER);n.CanvasRenderer.instance.render(t,this,r)},_determineEventTarget:function(e){return this._getEntityByPosition(e.x,e.y)},_getEntityByPosition:function(e,t){var r=n.Core.instance;var i=this._dctx;if(this._lastDetected<r.frame){i.clearRect(0,0,this.width,this.height);n.CanvasRenderer.instance.detectRender(i,this);this._lastDetected=r.frame}var s=i.getImageData(e,t,1,1).data;return this._colorManager.getSpriteByColor(s)}});n.CanvasLayer._attachCache=function(e,t,r,i){var s;if(!e._cvsCache){e._cvsCache={};e._cvsCache.matrix=[1,0,0,1,0,0];e._cvsCache.detectColor="rgba("+t._colorManager.attachDetectColor(e)+")";e.addEventListener("childadded",r);e.addEventListener("childremoved",i)}if(e.childNodes){for(var o=0,u=e.childNodes.length;o<u;o++){s=e.childNodes[o];n.CanvasLayer._attachCache(s,t,r,i)}}};n.CanvasLayer._detachCache=function(e,t,r,i){var s;if(e._cvsCache){t._colorManager.detachDetectColor(e);e.removeEventListener("childadded",r);e.removeEventListener("childremoved",i);delete e._cvsCache}if(e.childNodes){for(var o=0,u=e.childNodes.length;o<u;o++){s=e.childNodes[o];n.CanvasLayer._detachCache(s,t,r,i)}}};n.CanvasRenderer=n.Class.create({render:function(e,t,r){var i,s,o;e.save();t.dispatchEvent(r);this.transform(e,t);if(typeof t._visible==="undefined"||t._visible){i=t.width;s=t.height;if(t.compositeOperation){e.globalCompositeOperation=t.compositeOperation}e.globalAlpha=typeof t._opacity==="number"?t._opacity:1;if(t._backgroundColor){e.fillStyle=t._backgroundColor;e.fillRect(0,0,i,s)}if(t.cvsRender){t.cvsRender(e)}if(n.Core.instance._debug&&t._debugColor){e.strokeStyle=t._debugColor;e.strokeRect(0,0,i,s)}if(t._clipping){e.beginPath();e.rect(0,0,i,s);e.clip()}if(t.childNodes){for(var u=0,a=t.childNodes.length;u<a;u++){o=t.childNodes[u];this.render(e,o,r)}}}e.restore();n.Matrix.instance.stack.pop()},detectRender:function(e,t){var r,i,s;if(typeof t._visible==="undefined"||t._visible){r=t.width;i=t.height;e.save();this.transform(e,t);e.fillStyle=t._cvsCache.detectColor;if(t._touchEnabled){if(t.detectRender){t.detectRender(e)}else{e.fillRect(0,0,r,i)}}if(t._clipping){e.beginPath();e.rect(0,0,r,i);e.clip()}if(t.childNodes){for(var o=0,u=t.childNodes.length;o<u;o++){s=t.childNodes[o];this.detectRender(e,s)}}e.restore();n.Matrix.instance.stack.pop()}},transform:function(e,t){var r=n.Matrix.instance;var i=r.stack;var s,o,u,a;if(t._dirty){r.makeTransformMatrix(t,t._cvsCache.matrix);s=[];r.multiply(i[i.length-1],t._cvsCache.matrix,s);t._matrix=s;o=typeof t._originX==="number"?t._originX:t._width/2||0;u=typeof t._originY==="number"?t._originY:t._height/2||0;a=[o,u];r.multiplyVec(s,a,a);t._offsetX=a[0]-o;t._offsetY=a[1]-u;t._dirty=false}else{s=t._matrix}i.push(s);e.setTransform.apply(e,s)}});n.CanvasRenderer.instance=new n.CanvasRenderer;n.Scene=n.Class.create(n.Group,{initialize:function(){var e=n.Core.instance;n.Group.call(this);this.scene=this;this._backgroundColor=null;this._element=document.createElement("div");this._element.style.position="absolute";this._element.style.overflow="hidden";this._element.style[n.ENV.VENDOR_PREFIX+"TransformOrigin"]="0 0";this._layers={};this._layerPriority=[];this.addEventListener(n.Event.CHILD_ADDED,this._onchildadded);this.addEventListener(n.Event.CHILD_REMOVED,this._onchildremoved);this.addEventListener(n.Event.ENTER,this._onenter);this.addEventListener(n.Event.EXIT,this._onexit);var t=this;this._dispatchExitframe=function(){var e;for(var r in t._layers){e=t._layers[r];e.dispatchEvent(new n.Event(n.Event.EXIT_FRAME))}};this.addEventListener(n.Event.CORE_RESIZE,this._oncoreresize);this._oncoreresize(e)},x:{get:function(){return this._x},set:function(e){this._x=e;for(var t in this._layers){this._layers[t].x=e}}},y:{get:function(){return this._y},set:function(e){this._y=e;for(var t in this._layers){this._layers[t].y=e}}},width:{get:function(){return this._width},set:function(e){this._width=e;for(var t in this._layers){this._layers[t].width=e}}},height:{get:function(){return this._height},set:function(e){this._height=e;for(var t in this._layers){this._layers[t].height=e}}},rotation:{get:function(){return this._rotation},set:function(e){this._rotation=e;for(var t in this._layers){this._layers[t].rotation=e}}},scaleX:{get:function(){return this._scaleX},set:function(e){this._scaleX=e;for(var t in this._layers){this._layers[t].scaleX=e}}},scaleY:{get:function(){return this._scaleY},set:function(e){this._scaleY=e;for(var t in this._layers){this._layers[t].scaleY=e}}},backgroundColor:{get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=this._element.style.backgroundColor=e}},_oncoreresize:function(e){this._element.style.width=e.width+"px";this.width=e.width;this._element.style.height=e.height+"px";this.height=e.height;this._element.style[n.ENV.VENDOR_PREFIX+"Transform"]="scale("+e.scale+")";for(var t in this._layers){this._layers[t].dispatchEvent(e)}},addLayer:function(e,t){var r=n.Core.instance;if(this._layers[e]){return}var i=new n[e+"Layer"];if(r.currentScene===this){i._startRendering()}this._layers[e]=i;var s=i._element;if(typeof t==="number"){var o=this._element.childNodes[t];if(o){this._element.insertBefore(s,o)}else{this._element.appendChild(s)}this._layerPriority.splice(t,0,e)}else{this._element.appendChild(s);this._layerPriority.push(e)}i._scene=this},_determineEventTarget:function(e){var t,n;for(var r=this._layerPriority.length-1;r>=0;r--){t=this._layers[this._layerPriority[r]];n=t._determineEventTarget(e);if(n){break}}if(!n){n=this}return n},_onchildadded:function(e){var t=e.node;var n=e.next;var r,i;if(t._element){r="Dom";i=1}else{r="Canvas";i=0}if(!this._layers[r]){this.addLayer(r,i)}t._layer=this._layers[r];this._layers[r].insertBefore(t,n);t.parentNode=this},_onchildremoved:function(e){var t=e.node;t._layer.removeChild(t);t._layer=null},_onenter:function(){for(var e in this._layers){this._layers[e]._startRendering()}n.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){for(var e in this._layers){this._layers[e]._stopRendering()}n.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}});n.LoadingScene=n.Class.create(n.Scene,{initialize:function(){n.Scene.call(this);this.backgroundColor="#000";var e=this.width*.4|0;var t=this.width*.05|0;var r=e*.03|0;var i=new n.Sprite(e,t);i.disableCollection();i.x=(this.width-e)/2;i.y=(this.height-t)/2;var s=new n.Surface(e,t);s.context.fillStyle="#fff";s.context.fillRect(0,0,e,t);s.context.fillStyle="#000";s.context.fillRect(r,r,e-r*2,t-r*2);i.image=s;var o=0,u=0;this.addEventListener("progress",function(e){o=e.loaded/e.total*1});i.addEventListener("enterframe",function(){u*=.9;u+=o*.1;s.context.fillStyle="#fff";s.context.fillRect(r,0,(e-r*2)*u,t)});this.addChild(i);this.addEventListener("load",function(e){var t=n.Core.instance;t.removeScene(t.loadingScene);t.dispatchEvent(e)})}});n.CanvasScene=n.Class.create(n.Scene,{initialize:function(){n.Scene.call(this);this.addLayer("Canvas")},_determineEventTarget:function(e){var t=this._layers.Canvas._determineEventTarget(e);if(!t){t=this}return t},_onchildadded:function(e){var t=e.node;var n=e.next;t._layer=this._layers.Canvas;this._layers.Canvas.insertBefore(t,n)},_onenter:function(){this._layers.Canvas._startRendering();n.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){this._layers.Canvas._stopRendering();n.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}});n.DOMScene=n.Class.create(n.Scene,{initialize:function(){n.Scene.call(this);this.addLayer("Dom")},_determineEventTarget:function(e){var t=this._layers.Dom._determineEventTarget(e);if(!t){t=this}return t},_onchildadded:function(e){var t=e.node;var n=e.next;t._layer=this._layers.Dom;this._layers.Dom.insertBefore(t,n)},_onenter:function(){this._layers.Dom._startRendering();n.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){this._layers.Dom._stopRendering();n.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}});n.Surface=n.Class.create(n.EventTarget,{initialize:function(e,t){n.EventTarget.call(this);var r=n.Core.instance;this.width=e;this.height=t;this.context=null;var i="enchant-surface"+r._surfaceID++;if(document.getCSSCanvasContext){this.context=document.getCSSCanvasContext("2d",i,e,t);this._element=this.context.canvas;this._css="-webkit-canvas("+i+")";var s=this.context}else if(document.mozSetImageElement){this._element=document.createElement("canvas");this._element.width=e;this._element.height=t;this._css="-moz-element(#"+i+")";this.context=this._element.getContext("2d");document.mozSetImageElement(i,this._element)}else{this._element=document.createElement("canvas");this._element.width=e;this._element.height=t;this._element.style.position="absolute";this.context=this._element.getContext("2d");n.ENV.CANVAS_DRAWING_METHODS.forEach(function(e){var t=this.context[e];this.context[e]=function(){t.apply(this,arguments);this._dirty=true}},this)}},getPixel:function(e,t){return this.context.getImageData(e,t,1,1).data},setPixel:function(e,t,n,r,i,s){var o=this.context.createImageData(1,1);o.data[0]=n;o.data[1]=r;o.data[2]=i;o.data[3]=s;this.context.putImageData(o,e,t)},clear:function(){this.context.clearRect(0,0,this.width,this.height)},draw:function(e){e=e._element;if(arguments.length===1){this.context.drawImage(e,0,0)}else{var t=arguments;t[0]=e;this.context.drawImage.apply(this.context,t)}},clone:function(){var e=new n.Surface(this.width,this.height);e.draw(this);return e},toDataURL:function(){var e=this._element.src;if(e){if(e.slice(0,5)==="data:"){return e}else{return this.clone().toDataURL()}}else{return this._element.toDataURL()}}});n.Surface.load=function(e,t,r){var i=new Image;var s=Object.create(n.Surface.prototype,{context:{value:null},_css:{value:"url("+e+")"},_element:{value:i}});n.EventTarget.call(s);r=r||function(){};s.addEventListener("load",t);s.addEventListener("error",r);i.onerror=function(){var e=new n.Event(n.Event.ERROR);e.message="Cannot load an asset: "+i.src;n.Core.instance.dispatchEvent(e);s.dispatchEvent(e)};i.onload=function(){s.width=i.width;s.height=i.height;s.dispatchEvent(new n.Event("load"))};i.src=e;return s};n.Surface._staticCanvas2DContext=document.createElement("canvas").getContext("2d");n.Surface._getPattern=function(e,t){if(!e._pattern||t){e._pattern=this._staticCanvas2DContext.createPattern(e._element,"repeat")}return e._pattern};if(e.Deferred){n.Deferred=e.Deferred}else{n.Deferred=n.Class.create({initialize:function(){this._succ=this._fail=this._next=this._id=null;this._tail=this},next:function(e){var t=new n.Deferred;t._succ=e;return this._add(t)},error:function(e){var t=new n.Deferred;t._fail=e;return this._add(t)},_add:function(e){this._tail._next=e;this._tail=e;return this},call:function(e){var t;var r=this;while(r&&!r._succ){r=r._next}if(!(r instanceof n.Deferred)){return}try{t=r._succ(e)}catch(i){return r.fail(i)}if(t instanceof n.Deferred){n.Deferred._insert(r,t)}else if(r._next instanceof n.Deferred){r._next.call(t)}},fail:function(e){var t,r,i=this;while(i&&!i._fail){i=i._next}if(i instanceof n.Deferred){t=i._fail(e);i.call(t)}else if(e instanceof Error){throw e}else{r=new Error("failed in Deferred");r.arg=e;throw r}}});n.Deferred._insert=function(e,t){if(e._next instanceof n.Deferred){t._tail._next=e._next}e._next=t};n.Deferred.next=function(e){var t=(new n.Deferred).next(e);t._id=setTimeout(function(){t.call()},0);return t};n.Deferred.parallel=function(e){var t=new n.Deferred;t._id=setTimeout(function(){t.call()},0);var r=0;var i=e instanceof Array?[]:{};var s=new n.Deferred;for(var o in e){if(e.hasOwnProperty(o)){r++;(function(e,t){e.next(function(e){r--;i[t]=e;if(r<=0){s.call(i)}}).error(function(e){s.fail(e)});if(typeof e._id==="number"){clearTimeout(e._id)}e._id=setTimeout(function(){e.call()},0)})(e[o],o)}}if(!r){s._id=setTimeout(function(){s.call(i)},0)}return t.next(function(){return s})}}n.DOMSound=n.Class.create(n.EventTarget,{initialize:function(){n.EventTarget.call(this);this.duration=0;throw new Error("Illegal Constructor")},play:function(){if(this._element){this._element.play()}},pause:function(){if(this._element){this._element.pause()}},stop:function(){this.pause();this.currentTime=0},clone:function(){var e;if(this._element instanceof Audio){e=Object.create(n.DOMSound.prototype,{_element:{value:this._element.cloneNode(false)},duration:{value:this.duration}})}else if(n.ENV.USE_FLASH_SOUND){return this}else{e=Object.create(n.DOMSound.prototype)}n.EventTarget.call(e);return e},currentTime:{get:function(){return this._element?this._element.currentTime:0},set:function(e){if(this._element){this._element.currentTime=e}}},volume:{get:function(){return this._element?this._element.volume:1},set:function(e){if(this._element){this._element.volume=e}}}});n.DOMSound.load=function(t,r,i,s){if(r==null){var o=n.Core.findExt(t);if(o){r="audio/"+o}else{r=""}}r=r.replace("mp3","mpeg").replace("m4a","mp4");i=i||function(){};s=s||function(){};var u=Object.create(n.DOMSound.prototype);n.EventTarget.call(u);u.addEventListener("load",i);u.addEventListener("error",s);var a=new Audio;if(!n.ENV.SOUND_ENABLED_ON_MOBILE_SAFARI&&n.ENV.VENDOR_PREFIX==="webkit"&&n.ENV.TOUCH_ENABLED){e.setTimeout(function(){u.dispatchEvent(new n.Event("load"))},0)}else{if(!n.ENV.USE_FLASH_SOUND&&a.canPlayType(r)){a.addEventListener("canplaythrough",function c(){u.duration=a.duration;u.dispatchEvent(new n.Event("load"));a.removeEventListener("canplaythrough",c)},false);a.src=t;a.load();a.autoplay=false;a.onerror=function(){var e=new n.Event(n.Event.ERROR);e.message="Cannot load an asset: "+a.src;n.Core.instance.dispatchEvent(e);u.dispatchEvent(e)};u._element=a}else if(r==="audio/mpeg"){var f=document.createElement("embed");var l="enchant-audio"+n.Core.instance._soundID++;f.width=f.height=1;f.name=l;f.src="sound.swf?id="+l+"&src="+t;f.allowscriptaccess="always";f.style.position="absolute";f.style.left="-1px";u.addEventListener("load",function(){Object.defineProperties(f,{currentTime:{get:function(){return f.getCurrentTime()},set:function(e){f.setCurrentTime(e)}},volume:{get:function(){return f.getVolume()},set:function(e){f.setVolume(e)}}});u._element=f;u.duration=f.getDuration()});n.Core.instance._element.appendChild(f);n.DOMSound[l]=u}else{e.setTimeout(function(){u.dispatchEvent(new n.Event("load"))},0)}}return u};e.AudioContext=e.AudioContext||e.webkitAudioContext||e.mozAudioContext||e.msAudioContext||e.oAudioContext;n.WebAudioSound=n.Class.create(n.EventTarget,{initialize:function(){if(!e.AudioContext){throw new Error("This browser does not support WebAudio API.")}n.EventTarget.call(this);this.context=n.WebAudioSound.audioContext;this.src=this.context.createBufferSource();this.buffer=null;this._volume=1;this._currentTime=0;this._state=0;this.connectTarget=n.WebAudioSound.destination},play:function(e){if(this._state===1&&!e){this.src.disconnect(this.connectTarget)}if(this._state!==2){this._currentTime=0}var t=this._currentTime;var n=this.context;this.src=n.createBufferSource();if(n.createGain!=null){this._gain=n.createGain()}else{this._gain=n.createGainNode()}this.src.buffer=this.buffer;this._gain.gain.value=this._volume;this.src.connect(this._gain);this._gain.connect(this.connectTarget);if(this.src.start!=null){this.src.start(0,t,this.buffer.duration-t-1.192e-7)}else{this.src.noteGrainOn(0,t,this.buffer.duration-t-1.192e-7)}this._startTime=n.currentTime-this._currentTime;this._state=1},pause:function(){var e=this.currentTime;if(e===this.duration){return}if(this.src.stop!=null){this.src.stop(0)}else{this.src.noteOff(0)}this._currentTime=e;this._state=2},stop:function(){if(this.src.stop!=null){this.src.stop(0)}else{this.src.noteOff(0)}this._state=0},clone:function(){var e=new n.WebAudioSound;e.buffer=this.buffer;return e},duration:{get:function(){if(this.buffer){return this.buffer.duration}else{return 0}}},volume:{get:function(){return this._volume},set:function(e){e=Math.max(0,Math.min(1,e));this._volume=e;if(this.src){this._gain.gain.value=e}}},currentTime:{get:function(){return Math.max(0,Math.min(this.duration,this.src.context.currentTime-this._startTime))},set:function(e){this._currentTime=e;if(this._state!==2){this.play(false)}}}});n.WebAudioSound.load=function(e,t,r,i){function u(){var t=new n.Event(n.Event.ERROR);t.message="Cannot load an asset: "+e;n.Core.instance.dispatchEvent(t);o.dispatchEvent(t)}var s=(new Audio).canPlayType(t);var o=new n.WebAudioSound;r=r||function(){};i=i||function(){};o.addEventListener(n.Event.LOAD,r);o.addEventListener(n.Event.ERROR,i);var a,f;if(s==="maybe"||s==="probably"){a=n.WebAudioSound.audioContext;f=new XMLHttpRequest;f.open("GET",e,true);f.responseType="arraybuffer";f.onload=function(){a.decodeAudioData(f.response,function(e){o.buffer=e;o.dispatchEvent(new n.Event(n.Event.LOAD))},u)};f.onerror=u;f.send(null)}else{setTimeout(u,50)}return o};if(e.AudioContext){n.WebAudioSound.audioContext=new e.AudioContext;n.WebAudioSound.destination=n.WebAudioSound.audioContext.destination}n.Sound=e.AudioContext&&n.ENV.USE_WEBAUDIO?n.WebAudioSound:n.DOMSound;n.Easing={LINEAR:function(e,t,n,r){return n*e/r+t},SWING:function(e,t,n,r){return n*(.5-Math.cos(e/r*Math.PI)/2)+t},QUAD_EASEIN:function(e,t,n,r){return n*(e/=r)*e+t},QUAD_EASEOUT:function(e,t,n,r){return-n*(e/=r)*(e-2)+t},QUAD_EASEINOUT:function(e,t,n,r){if((e/=r/2)<1){return n/2*e*e+t}return-n/2*(--e*(e-2)-1)+t},CUBIC_EASEIN:function(e,t,n,r){return n*(e/=r)*e*e+t},CUBIC_EASEOUT:function(e,t,n,r){return n*((e=e/r-1)*e*e+1)+t},CUBIC_EASEINOUT:function(e,t,n,r){if((e/=r/2)<1){return n/2*e*e*e+t}return n/2*((e-=2)*e*e+2)+t},QUART_EASEIN:function(e,t,n,r){return n*(e/=r)*e*e*e+t},QUART_EASEOUT:function(e,t,n,r){return-n*((e=e/r-1)*e*e*e-1)+t},QUART_EASEINOUT:function(e,t,n,r){if((e/=r/2)<1){return n/2*e*e*e*e+t}return-n/2*((e-=2)*e*e*e-2)+t},QUINT_EASEIN:function(e,t,n,r){return n*(e/=r)*e*e*e*e+t},QUINT_EASEOUT:function(e,t,n,r){return n*((e=e/r-1)*e*e*e*e+1)+t},QUINT_EASEINOUT:function(e,t,n,r){if((e/=r/2)<1){return n/2*e*e*e*e*e+t}return n/2*((e-=2)*e*e*e*e+2)+t},SIN_EASEIN:function(e,t,n,r){return-n*Math.cos(e/r*(Math.PI/2))+n+t},SIN_EASEOUT:function(e,t,n,r){return n*Math.sin(e/r*(Math.PI/2))+t},SIN_EASEINOUT:function(e,t,n,r){return-n/2*(Math.cos(Math.PI*e/r)-1)+t},CIRC_EASEIN:function(e,t,n,r){return-n*(Math.sqrt(1-(e/=r)*e)-1)+t},CIRC_EASEOUT:function(e,t,n,r){return n*Math.sqrt(1-(e=e/r-1)*e)+t},CIRC_EASEINOUT:function(e,t,n,r){if((e/=r/2)<1){return-n/2*(Math.sqrt(1-e*e)-1)+t}return n/2*(Math.sqrt(1-(e-=2)*e)+1)+t},ELASTIC_EASEIN:function(e,t,n,r,i,s){if(e===0){return t}if((e/=r)===1){return t+n}if(!s){s=r*.3}var o;if(!i||i<Math.abs(n)){i=n;o=s/4}else{o=s/(2*Math.PI)*Math.asin(n/i)}return-(i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s))+t},ELASTIC_EASEOUT:function(e,t,n,r,i,s){if(e===0){return t}if((e/=r)===1){return t+n}if(!s){s=r*.3}var o;if(!i||i<Math.abs(n)){i=n;o=s/4}else{o=s/(2*Math.PI)*Math.asin(n/i)}return i*Math.pow(2,-10*e)*Math.sin((e*r-o)*2*Math.PI/s)+n+t},ELASTIC_EASEINOUT:function(e,t,n,r,i,s){if(e===0){return t}if((e/=r/2)===2){return t+n}if(!s){s=r*.3*1.5}var o;if(!i||i<Math.abs(n)){i=n;o=s/4}else{o=s/(2*Math.PI)*Math.asin(n/i)}if(e<1){return-.5*i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)+t}return i*Math.pow(2,-10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)*.5+n+t},BOUNCE_EASEOUT:function(e,t,n,r){if((e/=r)<1/2.75){return n*7.5625*e*e+t}else if(e<2/2.75){return n*(7.5625*(e-=1.5/2.75)*e+.75)+t}else if(e<2.5/2.75){return n*(7.5625*(e-=2.25/2.75)*e+.9375)+t}else{return n*(7.5625*(e-=2.625/2.75)*e+.984375)+t}},BOUNCE_EASEIN:function(e,t,r,i){return r-n.Easing.BOUNCE_EASEOUT(i-e,0,r,i)+t},BOUNCE_EASEINOUT:function(e,t,r,i){if(e<i/2){return n.Easing.BOUNCE_EASEIN(e*2,0,r,i)*.5+t}else{return n.Easing.BOUNCE_EASEOUT(e*2-i,0,r,i)*.5+r*.5+t}},BACK_EASEIN:function(e,n,r,i,s){if(s===t){s=1.70158}return r*(e/=i)*e*((s+1)*e-s)+n},BACK_EASEOUT:function(e,n,r,i,s){if(s===t){s=1.70158}return r*((e=e/i-1)*e*((s+1)*e+s)+1)+n},BACK_EASEINOUT:function(e,n,r,i,s){if(s===t){s=1.70158}if((e/=i/2)<1){return r/2*e*e*(((s*=1.525)+1)*e-s)+n}return r/2*((e-=2)*e*(((s*=1.525)+1)*e+s)+2)+n},EXPO_EASEIN:function(e,t,n,r){return e===0?t:n*Math.pow(2,10*(e/r-1))+t},EXPO_EASEOUT:function(e,t,n,r){return e===r?t+n:n*(-Math.pow(2,-10*e/r)+1)+t},EXPO_EASEINOUT:function(e,t,n,r){if(e===0){return t}if(e===r){return t+n}if((e/=r/2)<1){return n/2*Math.pow(2,10*(e-1))+t}return n/2*(-Math.pow(2,-10*--e)+2)+t}};n.ActionEventTarget=n.Class.create(n.EventTarget,{initialize:function(){n.EventTarget.apply(this,arguments)},dispatchEvent:function(e){var t;if(this.node){t=this.node;e.target=t;e.localX=e.x-t._offsetX;e.localY=e.y-t._offsetY}else{this.node=null}if(this["on"+e.type]!=null){this["on"+e.type].call(t,e)}var n=this._listeners[e.type];if(n!=null){n=n.slice();for(var r=0,i=n.length;r<i;r++){n[r].call(t,e)}}}});n.Timeline=n.Class.create(n.EventTarget,{initialize:function(e){n.EventTarget.call(this);this.node=e;this.queue=[];this.paused=false;this.looped=false;this.isFrameBased=true;this._parallel=null;this._activated=false;this.addEventListener(n.Event.ENTER_FRAME,this.tick)},_deactivateTimeline:function(){if(this._activated){this._activated=false;this.node.removeEventListener("enterframe",this._nodeEventListener)}},_activateTimeline:function(){if(!this._activated&&!this.paused){this.node.addEventListener("enterframe",this._nodeEventListener);this._activated=true}},setFrameBased:function(){this.isFrameBased=true},setTimeBased:function(){this.isFrameBased=false},next:function(e){var t,r=this.queue.shift();if(r){t=new n.Event("actionend");t.timeline=this;r.dispatchEvent(t)}if(this.queue.length===0){this._activated=false;this.node.removeEventListener("enterframe",this._nodeEventListener);return}if(this.looped){t=new n.Event("removedfromtimeline");t.timeline=this;r.dispatchEvent(t);r.frame=0;this.add(r)}else{t=new n.Event("removedfromtimeline");t.timeline=this;r.dispatchEvent(t)}if(e>0||this.queue[0]&&this.queue[0].time===0){var i=new n.Event("enterframe");i.elapsed=e;this.dispatchEvent(i)}},tick:function(e){if(this.paused){return}if(this.queue.length>0){var t=this.queue[0];if(t.frame===0){var r;r=new n.Event("actionstart");r.timeline=this;t.dispatchEvent(r)}var i=new n.Event("actiontick");i.timeline=this;if(this.isFrameBased){i.elapsed=1}else{i.elapsed=e.elapsed}t.dispatchEvent(i)}},add:function(e){if(!this._activated){var t=this;this._nodeEventListener=function(e){t.dispatchEvent(e)};this.node.addEventListener("enterframe",this._nodeEventListener);this._activated=true}if(this._parallel){this._parallel.actions.push(e);this._parallel=null}else{this.queue.push(e)}e.frame=0;var r=new n.Event("addedtotimeline");r.timeline=this;e.dispatchEvent(r);r=new n.Event("actionadded");r.action=e;this.dispatchEvent(r);return this},action:function(e){return this.add(new n.Action(e))},tween:function(e){return this.add(new n.Tween(e))},clear:function(){var e=new n.Event("removedfromtimeline");e.timeline=this;for(var t=0,r=this.queue.length;t<r;t++){this.queue[t].dispatchEvent(e)}this.queue=[];this._deactivateTimeline();return this},skip:function(e){var t=new n.Event("enterframe");if(this.isFrameBased){t.elapsed=1}else{t.elapsed=e;e=1}while(e--){this.dispatchEvent(t)}return this},pause:function(){if(!this.paused){this.paused=true;this._deactivateTimeline()}return this},resume:function(){if(this.paused){this.paused=false;this._activateTimeline()}return this},loop:function(){this.looped=true;return this},unloop:function(){this.looped=false;return this},delay:function(e){this.add(new n.Action({time:e}));return this},wait:function(e){return this},then:function(e){var t=this;this.add(new n.Action({onactiontick:function(n){e.call(t.node)},time:0}));return this},exec:function(e){this.then(e)},cue:function(e){var t=0;for(var n in e){if(e.hasOwnProperty(n)){this.delay(n-t);this.then(e[n]);t=n}}},repeat:function(e,t){this.add(new n.Action({onactiontick:function(t){e.call(this)},time:t}));return this},and:function(){var e=this.queue.pop();if(e instanceof n.ParallelAction){this._parallel=e;this.queue.push(e)}else{var t=new n.ParallelAction;t.actions.push(e);this.queue.push(t);this._parallel=t}return this},or:function(){return this},doAll:function(e){return this},waitAll:function(){return this},waitUntil:function(e){var t=this;this.add(new n.Action({onactionstart:e,onactiontick:function(n){if(e.call(this)){t.next()}}}));return this},fadeTo:function(e,t,n){this.tween({opacity:e,time:t,easing:n});return this},fadeIn:function(e,t){return this.fadeTo(1,e,t)},fadeOut:function(e,t){return this.fadeTo(0,e,t)},moveTo:function(e,t,n,r){return this.tween({x:e,y:t,time:n,easing:r})},moveX:function(e,t,n){return this.tween({x:e,time:t,easing:n})},moveY:function(e,t,n){return this.tween({y:e,time:t,easing:n})},moveBy:function(e,t,n,r){return this.tween({x:function(){return this.x+e},y:function(){return this.y+t},time:n,easing:r})},hide:function(){return this.then(function(){this.opacity=0})},show:function(){return this.then(function(){this.opacity=1})},removeFromScene:function(){return this.then(function(){this.scene.removeChild(this)})},scaleTo:function(e,t,n){if(typeof n==="number"){return this.tween({scaleX:arguments[0],scaleY:arguments[1],time:arguments[2],easing:arguments[3]})}return this.tween({scaleX:e,scaleY:e,time:t,easing:n})},scaleBy:function(e,t,n){if(typeof n==="number"){return this.tween({scaleX:function(){return this.scaleX*arguments[0]},scaleY:function(){return this.scaleY*arguments[1]},time:arguments[2],easing:arguments[3]})}return this.tween({scaleX:function(){return this.scaleX*e},scaleY:function(){return this.scaleY*e},time:t,easing:n})},rotateTo:function(e,t,n){return this.tween({rotation:e,time:t,easing:n})},rotateBy:function(e,t,n){return this.tween({rotation:function(){return this.rotation+e},time:t,easing:n})}});n.Action=n.Class.create(n.ActionEventTarget,{initialize:function(e){n.ActionEventTarget.call(this);this.time=null;this.frame=0;for(var t in e){if(e.hasOwnProperty(t)){if(e[t]!=null){this[t]=e[t]}}}var r=this;this.timeline=null;this.node=null;this.addEventListener(n.Event.ADDED_TO_TIMELINE,function(e){r.timeline=e.timeline;r.node=e.timeline.node;r.frame=0});this.addEventListener(n.Event.REMOVED_FROM_TIMELINE,function(){r.timeline=null;r.node=null;r.frame=0});this.addEventListener(n.Event.ACTION_TICK,function(e){var t=r.time-(r.frame+e.elapsed);if(r.time!=null&&t<=0){r.frame=r.time;e.timeline.next(-t)}else{r.frame+=e.elapsed}})}});n.ParallelAction=n.Class.create(n.Action,{initialize:function(e){n.Action.call(this,e);var t=this.timeline;var r=this.node;this.actions=[];this.endedActions=[];var i=this;this.addEventListener(n.Event.ACTION_START,function(e){for(var t=0,n=i.actions.length;t<n;t++){i.actions[t].dispatchEvent(e)}});this.addEventListener(n.Event.ACTION_TICK,function(e){var t,r,s={next:function(e){var s=i.actions[t];i.actions.splice(t--,1);r=i.actions.length;i.endedActions.push(s);var o=new n.Event("actionend");o.timeline=this;s.dispatchEvent(o);o=new n.Event("removedfromtimeline");o.timeline=this;s.dispatchEvent(o)}};var o=new n.Event("actiontick");o.timeline=s;o.elapsed=e.elapsed;for(t=0,r=i.actions.length;t<r;t++){i.actions[t].dispatchEvent(o)}if(i.actions.length===0){e.timeline.next()}});this.addEventListener(n.Event.ADDED_TO_TIMELINE,function(e){for(var t=0,n=i.actions.length;t<n;t++){i.actions[t].dispatchEvent(e)}});this.addEventListener(n.Event.REMOVED_FROM_TIMELINE,function(){this.actions=this.endedActions;this.endedActions=[]})}});n.Tween=n.Class.create(n.Action,{initialize:function(e){var t={};var r={};n.Action.call(this,e);if(this.easing==null){this.easing=function(e,t,n,r){return n*e/r+t}}var i=this;this.addEventListener(n.Event.ACTION_START,function(){var n=["frame","time","callback","onactiontick","onactionstart","onactionend"];for(var s in e){if(e.hasOwnProperty(s)){var o;if(typeof e[s]==="function"){o=e[s].call(i.node)}else{o=e[s]}if(n.indexOf(s)===-1){t[s]=i.node[s];r[s]=o}}}});this.addEventListener(n.Event.ACTION_TICK,function(e){var n=i.time===0?1:i.easing(Math.min(i.time,i.frame+e.elapsed),0,1,i.time)-i.easing(i.frame,0,1,i.time);for(var s in r){if(r.hasOwnProperty(s)){if(typeof this[s]==="undefined"){continue}i.node[s]+=(r[s]-t[s])*n;if(Math.abs(i.node[s])<1e-7){i.node[s]=0}}}})}})})(window)